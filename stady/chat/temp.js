STK.register("wbim.events",function(d){var f=d.core.evt.custEvent,b={};function e(h,g,i){f.add(this,h,g,i)}function c(h,g){f.fire(this,h,g)}function a(h,g){f.remove(this,h,g)}b.ui={add:e,fire:c,remove:a};b.io={add:e,fire:c,remove:a};b.sync={add:e,fire:c,remove:a};f.define(b.ui,"closeChatWindow");f.define(b.ui,"miniChatWindow");f.define(b.ui,"changeChatUser");f.define(b.ui,"afterUpdateUnreadMsgCount");f.define(b.ui,"activeChatUser");f.define(b.ui,"closeChatUser");f.define(b.ui,"cutUnreadCountEvent");f.define(b.ui,"onlineUser.offline");f.define(b.ui,"onlineUser.online");f.define(b.ui,"groupsDataReady");f.define(b.ui,"updateRecents");f.define(b.ui,"rosterUpdate");f.define(b.ui,"rosterRemove");f.define(b.ui,"contactPanel.LazyCheck");f.define(b.ui,"contactsPanel.userClicked");f.define(b.ui,"search");f.define(b.ui,"phiz.selectPhiz");f.define(b.ui,"receiveEmotions");f.define(b.ui,"sendMsg");f.define(b.ui,"selfChangeStatus");f.define(b.ui,"searchReturn");f.define(b.ui,"OnlineBar.OnClick");f.define(b.ui,"chatUserGroup.addUser");f.define(b.ui,"chatUserGroup.removeUser");f.define(b.ui,"receivedMsg");f.define(b.ui,"messagePop.click");f.define(b.ui,"selfStatus");f.define(b.ui,"realCloseChatWindow");f.define(b.ui,"updateOnlineUserCount");f.define(b.ui,"noNewMsg");f.define(b.ui,"chatWindow.hide2Bar");f.define(b.ui,"addedChatUserByNewMsg");f.define(b.ui,"updateUsersStatus");f.define(b.ui,"beforeHideChatWindow");f.define(b.ui,"createUploadTips");f.define(b.ui,"swf.upload.start");f.define(b.ui,"swf.upload.cancel");f.define(b.ui,"swf.upload.complete");f.define(b.ui,"swf.upload.showMsg");f.define(b.ui,"cancelUpload");f.define(b.ui,"deleteUpload");f.define(b.ui,"hideUploadTips");f.define(b.ui,"receiveFileInfo");f.define(b.ui,"showSysTips");f.define(b.ui,"uploadFile.rollback");f.define(b.ui,"historySendMsg");f.define(b.ui,"chatWindow.init");f.define(b.ui,"previewBox.changeUrl");f.define(b.ui,"requestInTextarea");f.define(b.ui,"addChartInputing");f.define(b.ui,"changeHeaderStatus");f.define(b.ui,"stopInputing");f.define(b.ui,"sendButtonChange");f.define(b.io,"comet_receive");f.define(b.io,"notSend2User");f.define(b.io,"userIsForbidden");f.define(b.io,"writeInitData");f.define(b.io,"reconnecting");f.define(b.sync,"dispatch");f.define(b.sync,"chatUser.active");f.define(b.sync,"chatUser.remove");f.define(b.sync,"chatWindow.hide");f.define(b.sync,"chatWindow.close");f.define(b.sync,"confirmWin.hide");f.define(b.sync,"contactsPanel.click");f.define(b.sync,"StatusManager.changeStatus");f.define(b.sync,"contactsPanel.display");f.define(b.sync,"msgEditor.sendMsg");f.define(b.sync,"uploadFile.rollback");f.define(b.sync,"changeSendMethod");return b});(function(){function a(){this.subscribers={}}a.prototype={publish:function(e,g){this.subscribers[e]=this.subscribers[e]||[];for(var f=0;f<this.subscribers[e].length;f++){var c=this.subscribers[e][f];if(typeof c==="function"){var h=[];for(var d=1,b=arguments.length;d<b;d++){h.push(arguments[d])}c.apply(this,h)}}},subscribe:function(b,d,c){this.subscribers[b]=this.subscribers[b]||[];this.subscribers[b].push(function(){(typeof d==="function")&&d.apply(c,arguments)})}};window.__PubSub__=window.__PubSub__||new a()})();STK.register("wbim.utils.Core",function(c){var a={zip:"rar",docx:"word",doc:"word",xls:"excel",xlsx:"excel",wma:"music",mp3:"music",exe:"exe",pdf:"pdf",rar:"rar",txt:"txt",pptx:"ppt",ppt:"ppt",flv:"video",mkv:"video",mp4:"video",mpeg:"video",mpg2:"video",rmvb:"video",avi:"video"},b=/\.([a-zA-Z0-9]+$)/;return{bindEvents:function(h,g,f){for(var e=0,d=f.length;e<d;e++){c.core.evt.addEvent(h,f[e],g)}},fixBottomForIE6:function(f,d){f.style.position="absolute";var h,g=document.compatMode&&(document.compatMode==="CSS1Compat");function e(){f.style.top=g?(document.documentElement.scrollTop+(document.documentElement.clientHeight-f.clientHeight)-d+"px"):(document.body.scrollTop+(document.body.clientHeight-f.clientHeight)-d+"px")}e();c.core.evt.addEvent(window,"scroll",function(){if(h){clearTimeout(h)}f.style.display="none";h=setTimeout(function(){e();f.style.display=""},300)});c.core.evt.addEvent(window,"resize",e)},flashFlg:function(){var f=false;if(c.IE){try{var d=new ActiveXObject("ShockwaveFlash.ShockwaveFlash");f=(d&&d.GetVariable("$version"))?true:false}catch(g){f=false}}else{f=(navigator.plugins["Shockwave Flash"]&&navigator.plugins["Shockwave Flash"]["description"])?true:false}return f}(),checkFlashVersion:function(d){if(!this.flashFlg){return false}var e=c.core.util.swf.check();if(c.IE){e=parseInt(e.split(" ")[1].split(",")[0])}else{e=parseInt(e.match(/Shockwave Flash (\d+)/)[1])}return(d<=e)},stopBubble:function(f){var d=f?f:c.core.evt.getEvent();if(c.IE){d.cancelBubble=true}else{d.stopPropagation()}},getFileImg:function(e){var f=b.exec(e),d=f?a[f[1]]:"";return d?d:"default"},getCurrentUIDByCookie:function(){var e=unescape(c.core.util.cookie.get("SUP")),d=e.match(/uid=([0-9]+)&/);if(e&&d&&d[1]){c.wbim.$currentUID=d[1];return c.wbim.$currentUID}else{window.location.replace("http://weibo.com/login.php")}}}});(function(h){var g=h.E("wbim_test"),c=[],a=null,b=null,e=15;var d=new Date().getTime();var f=0;window._webim_log=function(){if(window._debug_){g=g||document.body.appendChild(h.C("div"));try{if(window.console&&window.console.log){b=window.console.log}if(b&&!h.core.util.browser.IE){b.apply(console,arguments);var n=new Date().getTime();console.info(f++,"上一操作耗时：",n-d);d=n}else{if(h.core.util.browser.IE&&!h.core.util.browser.IE9){b=function(){}}var k=Array.prototype.slice.call(arguments);for(var m=0,l=k.length;m<l;m++){if(typeof(k[m])!="string"){k[m]=h.core.json.jsonToStr(k[m]);k[m]='<div title="双击可切换" class="code">'+k[m]+"</div>"}b(k[m])}c.push(k.join(" "));b("\n");if(!a){a=setInterval(function(){var i=c.slice(0);if(i.length>0){g.innerHTML=[g.innerHTML,i.join("<br/><br/>")].join("<br/><br/>")}c.length=0},500)}}}catch(o){}}}})(STK);STK.register("wbim.utils.date",function(c){var a=new Date().getTime(),b;return{format:function(l,e){var e=e||c.wbim.$baseServerTime;var r=new Date().getTime(),g=new Date(l),s,i,o,u,j,k,n=[(n=g.getHours())<10?"0":"",n].join(""),p=[(p=g.getMinutes())<10?"0":"",p].join(""),q,t;e=e+(((t=(r-a))<0)?0:t);a=r;r=new Date(e);s=r.getFullYear();i=r.getMonth();q=r.getDate();o=g.getFullYear();u=g.getMonth()+1;k=g.getDate();if((l-new Date(s,0,1).getTime())>-1){if((l-new Date(s,i,q).getTime())>0){return[n,p].join(":")}return[[u,k].join("-"),[n,p].join(":")].join(" ")}return[[o,u,k].join("-"),[n,p].join(":")].join(" ")},getFormatedCurrentTime:function(){return this.format(b,c.wbim.$baseServerTime)},getCurrentTime:function(){return b},startTiming:function(){var e=c.wbim.SyncStorage,d=0;b=parseInt(c.wbim.$baseServerTime)||(+new Date());window.setInterval(function(){b+=2000;(d++%3)||e.writeLastTime()},2000)}}});STK.register("wbim.utils.Array",function(b){var a=b.core.arr.indexOf;return{include:function(c,e){var d=a(e,c);if(d!==-1){c.push(e)}return c},erase:function(c,e){var d=a(e,c);if(d!==-1){c.splice(d,1)}},associate:function(e,g){var f={};for(var d=0,c=e.length;d<c;d++){f[e[d]]=g[d]}return f},filter:function(d,g){var f=[];for(var e,c=d.length;e<c;e++){var h=d[e];if(g(h,e)){f.push(h)}}return f}}});STK.register("wbim.utils.LazyLoader",function(d){var c=d.core.dom,a=d.core.dom.sizzle;function b(f){var e={prop:"imgsrc",container:null,sltImg:"",queue:true,delay:50,area:true,initCheck:false,checkLimited:null};this.options=d.core.obj.parseParam(e,f);this._bindEvents();if(this.options.initCheck){this.check.apply(this,arguments)}}b.prototype={_bindEvents:function(){var e=this;if(this.options.area){d.core.evt.addEvent(this.options.container,"scroll",function(){e.check.call(e)})}},_initHeight:function(e){if(!this.options.cHeight){this.options.cHeight=c.getSize(this.options.container).height}if(!this.options.iHeight){this.options.iHeight=c.getSize(e[0]).height}this._initHeight=null},_showByQueue:function(i){var f=this;var h=this.options.prop;var g=c.position(this.options.container).t;var e=g+this.options.cHeight;d.core.arr.foreach(i,function(j,k){if(!l.getAttribute(f.options.prop)){return}var l=j;var m=c.position(l).t;if(m<=e&&(m+f.options.iHeight)>=g){f.options.queList=f.options.queList||[];f.options.queList.push(l)}});if(this.options.queList&&this.options.queList[0]&&(!this.options.queing)){this.options.queing=true;(function(){var k=arguments.callee;var j=f.options.queList.shift();c.ready(function(){if(f.options.queList[0]){setTimeout(k,f.options.delay)}});j.setAttribute("src",j.getAttribute(f.options.prop));j.removeAttribute(f.options.prop)})()}if(!this.options.queList.length){this.options.queing=false}},_show:function(h){var g=c.position(this.options.container).t;var e=g+this.options.cHeight;var f=this;d.core.arr.foreach(h,function(k,j){if(!k.getAttribute(f.options.prop)){return}var l=c.position(k).t;if(l<=e&&(l+f.options.iHeight)>=g){k.setAttribute("src",k.getAttribute(f.options.prop));k.removeAttribute(f.options.prop)}})},_show2:function(f){var e=this;d.core.arr.foreach(f,function(m,l){if(!m.getAttribute(e.options.prop)){return}var k=m.parentNode.parentNode,h;if(k&&(h=k.offsetParent)){var o=h.scrollTop;var n=o+h.clientHeight;var g=k.offsetTop;var j=g+k.clientHeight;if(j<=n+30){m.setAttribute("src",m.getAttribute(e.options.prop));m.removeAttribute(e.options.prop)}}})},check:function(){var e=this;if(this.options.checkLimited&&this.options.checkLimited()){return}var f=[];d.core.arr.foreach(a(this.options.sltImg,this.options.container),function(g,h){if(g.getAttribute(e.options.prop)){f.push(g)}});if(f.length===0){return}if(this._initHeight){this._initHeight(f)}if(this.options.queue){this._showByQueue(f);setTimeout(function(){e._showByQueue.call(e,f)},100)}else{setTimeout(function(){e._show2(f)},100)}}};return b});(function(a){a.register("wbim.utils.Notification",function(b){return{requestPermission:function(c){c=c||function(){};window.webkitNotifications&&window.webkitNotifications.requestPermission(c)},notify:function(d,g,f,e){if(window.webkitNotifications&&window.webkitNotifications.createNotification){if(window.webkitNotifications.checkPermission()===1){return this.requestPermission()}if(window.webkitNotifications.checkPermission()===0&&window.localStorage&&f!==window.localStorage.getItem("_webim_last_msg_")){window.localStorage&&window.localStorage.setItem("_webim_last_msg_",f);var c=window.webkitNotifications.createNotification(d,g,f);c.show&&c.show();setTimeout(function(){c.cancel&&c.cancel()},e||7000)}}}}});if(window.webkitNotifications){a.core.dom.ready&&a.core.dom.ready(function(){a.core.evt.addEvent(document,"keydown",function(b){if(b.shiftKey&&b.altKey&&b.keyCode===78){if(window.webkitNotifications.checkPermission()===0){window.alert("你已经开启了Google Chrome浏览器桌面通知。可以到 chrome://settings/contentExceptions#notifications 取消通知。")}else{if(window.confirm("是否开启Google Chrome浏览器桌面通知？")){a.wbim.utils.Notification.requestPermission()}}}})})}})(STK);(function(a){a.WBIM=a.WBIM||{};var c=window,b=document;a.WBIM.init=function(){var e=a.C("div");e.id="wbim_box";e.className="wbim_box";var d=0;e.style.cssText="position:fixed;bottom:iBottompx;right:20px;".replace("iBottom",d);if(a.core.util.browser.IE6){a.wbim.utils.Core.fixBottomForIE6(e,d)}b.body.appendChild(e);return new a.wbim.io.Server()};a.WBIM.language=function(d){return a.core.util.language(d,a.WBIM.$LANG)}})(STK);STK.register("wbim.SyncStorage",function(f){var g=true,d=f.core.json.jsonToStr,c=f.core.json.strToJson,h=f.wbim.events.io,k=f.wbim.utils.date.getCurrentTime,b=f.wbim.utils.Core,a={},j=function(){return f.core.util.browser.IE?function(n,m,o){a[m]=o;setTimeout(function(){n.setSo(m,escape(d(a[m])))},Math.random()*100)}:function(n,m,o){a[m]=o;n.setSo(m,escape(d(o)));_webim_log("setSo",m,o)}}(),e=function(m){h.add("writeInitData",function(r,o,p){var q=(p?m.read(o):{})||{};for(var n in p){q[n]=p[n]}m.write(o,q)})};var l={flashStorage:{read:function(n){if(a[n]){return a[n]}var o=this.swf;if(o&&o.getSo){var m=o.getSo(n);try{return c((m?unescape(m):"{}"))}catch(p){window._debug_&&alert("error when JSON parse:"+d(p))}return{}}},write:function(m,o){var n=this.swf;if(g&&n&&n.setSo){try{j(n,m,o)}catch(p){window._debug_&&alert(d(p))}}},remove:function(m){this.write(m,"")},clear:function(){var m=this.swf;if(m&&m.clearSo){m.clearSo()}},writeLastTime:function(){var m=this.swf;if(m&&m.setSo){try{m.setSo("wbim_timestamp",'{"lastTime":'+(+new Date())+"}")}catch(n){window._debug_&&alert(d(n))}}},init:function(){e(this);this.loadFlash()},openWrite:function(){g=true},closeWrite:function(){g=false},loadFlash:function(){var o=f.C("div");o.id="webim_swf_box";o.style.cssText="position:absolute;bottom:2px;right:2px;z-index:1001;width:1px;height:1px";f.E("wbim_box").appendChild(o);var n,m=(+new Date());if(window.$CONFIG){m=window.$CONFIG.version||m;n="http://js.t.sinajs.cn/t4/webim/swf/sync_storage.swf?v=VER".replace("VER",m)}else{n="http://webim.sina.com.cn/t4/webim/swf/sync_storage.swf?v=VER".replace("VER",m)}var p=f.core.util.swf.create(o,n,{id:"webim_storage",paras:{allowScriptAccess:"always"},flashvars:{uid:f.wbim.$currentUID}});this.swf=p}},localStorage:{read:function(m){m=this.checkKey(m);if(a[m]){return a[m]}try{return c(unescape(window.localStorage.getItem(m)||"{}"))}catch(n){window._debug_&&alert("error when JSON parse:"+d(n))}return{}},write:function(m,n){if(g){m=this.checkKey(m);a[m]=n;window.localStorage.setItem(m,escape(d(n)))}},writeLastTime:function(){if(g){var m=k()||(+new Date());window.localStorage.setItem(this.checkKey("wbim_timestamp"),'{"lastTime":'+m+"}")}},remove:function(m){m=this.checkKey(m);localStorage.removeItem(m)},clear:function(){window.localStorage.clear()},init:function(){e(this)},openWrite:function(){g=true},closeWrite:function(){g=false},checkKey:function(m){if(f.wbim.$currentUID){m+=f.wbim.$currentUID}return m}},emptyStorage:{read:function(){return null},write:function(){},writeLastTime:function(){},remove:function(){},clear:function(){},init:function(){},closeWrite:function(){},openWrite:function(){}}};if(b.getCurrentUIDByCookie()){var i;if(b.flashFlg){i=l.flashStorage}else{if(window.localStorage){i=l.localStorage}else{i=l.emptyStorage}}l=null;return i}});STK.register("wbim.io.SyncData",function(d){var c=d.wbim.SyncStorage,a,e=d.core.json.jsonToStr;var b={dispatch:function(f,g){var h={};h.type=f;if(g){h.data=g}this.fire("dispatch",{syncData:e(h)})},receive:function(g){if(!a){return}c.closeWrite();g=d.core.json.strToJson(g);if(g.data){var f=g.data;this.fire(g.type,f)}else{this.fire(g.type)}c.openWrite()},enable:function(){a=true}};return d.core.json.merge(b,d.wbim.events.sync)});STK.register("wbim.model.UserData",function(d){var e=d.wbim.events.ui,b=d.core.arr.indexOf,g=d.wbim.utils.Array,f=d.core.arr.foreach,n=d.wbim.io.SyncData,i={"0":"offline","1":"online","2":"away","3":"busy","4":"hide","5":"online"},m="onlineusernogroup",o=["uid","nick","status","avatar","level","isFriend","sex","resource","group"],a=["uid","nick","status","group","avatar","level","sex","resource"],p=["uid","nick","status","avatar","sex","resource"],l=["uid","nick","status","avatar","isFriend","level","sex","resource"],q="http://api.weibo.com/im/file/imFileRepost.jsonp?fids=#{fids}&uid=#{uid}";function j(s){return i[s]||s}function k(s){var u;for(var t in i){if(i[t]==s){u=t;break}}return u=="5"?"1":u}function r(t){var s=t.split("_");return s.length>1?s[0]:""}function c(s,t){d.core.io.jsonp({url:d.core.util.templet(q,s),onComplete:function(u){_webim_log("sendFileInfo",s);if(u instanceof Array){u=u[0]}else{if(u&&u.err_msg){e.fire("swf.upload.showMsg",{msg:u.err_msg,err_code:u.err_code,fid:s.fids});d.wbim.io.SyncData.dispatch("uploadFile.rollback",{fid:s.fids})}}t&&t(u)}})}function h(s){this.userList={};this._client;this._activeUsers=[];this._receiveMsgCache=[];this._unreadObj={};this._receiveFlg=false;this._reconnecting;this._allRecents;this._groups;this._initUreadMsg;this.bindDataEvents();this.bindUISyncEvent();this.self={uid:null}}h.prototype={bindDataEvents:function(){var s=this,t={};e.add("selfChangeStatus",function(v,w){var u=k(w.status);s._client.selfPresence({status:u},function(x){s.setSelfStatus({status:u})})});e.add("sendMsg",function(w,x){var u=x.uid,v=x.ext&&{att_ids:[x.ext.fid]};if(x.ext){c({fids:v.att_ids[0],uid:u},function(y){if(y.fid){s._client.sendMsg({uid:u,msg:x.msg,x:{att_ids:[x.ext.fid,y.fid]}})}else{s._client.sendMsg({uid:u,msg:x.msg})}})}else{s._client.sendMsg({uid:u,msg:x.msg})}});e.add("cutUnreadCountEvent",function(v,w){var u=w.uid;g.erase(s._activeUsers,u);if(s._activeUsers.length==0){e.fire("noNewMsg")}t[u]=w.count;s._client.requestRevmsg({uid:u},function(){delete t[u]})});d.wbim.events.io.add("reconnecting",function(){if(s._reconnecting){return}s._reconnecting=true;f(t,function(v,u){if(v>0){s._unreadObj[u]={count:v,type:true}}});f(s.userList,function(u,v){var w=u.options.unreadMsgCount;if(w>0){s._unreadObj[v]={count:w}}})})},bindUISyncEvent:function(){var s=this;n.add("msgEditor.sendMsg",function(t,u){s.updateRecents(u.uid)})},addUsers:function(t){var s=this;f(t,function(v,u){if(s.userList[u]){s.userList[u].options=d.core.obj.parseParam(s.userList[u].options,v)}else{s.userList[u]=new d.wbim.model.User(v)}})},addUsersUnreadMsg:function(t,u){var s=this;f(t,function(v,w){if(s.userList[w]){s.userList[w][u?"addInitUreandMsg":"addUnreadMsg"](v)}})},addUserHistoryMsg:function(t){var s=this.userList[t.uid];s.addHistoryMsg&&s.addHistoryMsg(t)},getUser:function(s){return this.userList[s]},setSelfUid:function(s){this.self.uid=s.uid+""},setSelfStatus:function(s){this.self.status=s.status=j(s.status);e.fire("selfStatus",s)},initUsers:function(t){var s=this;this._reconnecting=false;this._allRecents=[];this._groups=[{type:"recents",uidList:[]},{}];this._addRecentUsers(t.recents);this._addOnlineUsers(t.items);e.fire("groupsDataReady",[this._groups]);this._groups=null;this._execUreadMsg(function(u){f(u,function(x,w){var v=x[0]+"",y=x[1];s._client.reuqestHistoryMsg({uids:v,count:y},function(B){var z=s._unreadObj[v],A;if(z){count=z.count;A=z.type;B.items.splice(y-count);delete s._unreadObj[v];y=A?(y-count):y}s.userList[v].options.unreadMsg=B.items;s.userList[v].options.unreadMsgCount=y;s.getUser(v).notify(y);s.updateRecents(v)})})})},_addRecentUsers:function(t){var s={},u=this;f(t,function(w,y){var v=g.associate(l,w),x;v.status=j(v.status.toString());v.resource=r(v.resource);v.unreadMsgCount=0;v.historyMsg=[];v.unreadMsg=[];x=v.uid=v.uid.toString();s[x]=v;u._allRecents.push(x);u._groups[0].uidList.push(x)});if(u._groups[0].uidList.length>10){u._groups[0].uidList=u._groups[0].uidList.splice(0,10)}u.addUsers(s)},_addOnlineUsers:function(s){var t={},u=this;f(s,function(x,z){var w=g.associate(a,x),y,v;w.status=j(w.status.toString());w.resource=r(w.resource);w.unreadMsgCount=0;w.historyMsg=[];w.unreadMsg=[];y=w.uid=w.uid.toString();if(!(w.group instanceof Array)||w.group.length==0){w.group=[m]}v=w.group;t[y]=w;f(v,function(B,A){u._groups[1][B]=u._groups[1][B]||{};u._groups[1][B].uidList=u._groups[1][B].uidList||[];u._groups[1][B].uidList.push(y)})});u.addUsers(t)},removeRoster:function(s){g.erase(this._allRecents,s);g.erase(this._activeUsers,s);this.updateRelation(s,0);e.fire("rosterRemove",{uid:s})},updateUser:function(v){var u=v.uid,s=v.user,t={};if(s){t[u]=s;this.addUsers(t)}e.fire("rosterUpdate",{uid:u})},updateRelation:function(s,t){this.userList[s]&&this.userList[s].options&&(this.userList[s].options.isFriend=t)},addSearchedUsers:function(s){var t={};f(s,function(v,w){var u=g.associate(p,v);u.status=j(u.status.toString());u.resource=r(u.resource);u.uid=u.uid.toString();t[u.uid]=u});e.fire("searchReturn",t)},getUserByVcard:function(t,s){this._client.getVcardInfo({uid:t},this._vcardCallback(s))},_vcardCallback:function(s){var t=this;return function(w){var v,u=g.associate(o,w.items);v=u.uid=u.uid.toString();u.status=j(u.status.toString());if(u.isFriend==1&&u.status!="hide"&&u.status!="offline"){u.group=(u.group.length==0)?[m]:u.group}t.updateUser({uid:v,user:u});s&&s.param.splice&&s.func.apply(s.obj,s.param)}},updateUsersPresence:function(t){var w=this,s={},v=arguments.callee,u;if(!(t[0] instanceof Array)){t=[t]}f(t,function(A,z){var y=A[0]+"",x=w.getUser(y);s[y]={uid:y,status:j(A[1]+""),resource:r(A[2])};if(x&&((x.options.isFriend!=1)||x.options.group)){x.updatePresence(s[y])}else{if(y==w.self.uid){w.setSelfStatus(s[y])}else{w.getUserByVcard(y,{func:v,obj:w,param:[t]});u=true;return false}}});if(!u){e.fire("updateUsersStatus",s)}},setClient:function(s){this._client=s},webkitNotify:function(s){var u=s[0],y=s[1],t=this.userList[u];var v=d.core.util.templet("http://tp#{imgserv}.sinaimg.cn/#{uid}/30/#{avatar}",{avatar:s[2],uid:u,imgserv:u%4+1});var w=d.WBIM.language;var x=t&&t.options&&t.options.nick?t.options.nick+w("#L{ 给你发私信啦：}"):w("#L{来新私信啦：}");s.length>2&&d.wbim.utils.Notification.notify(v,x,y)},execNewMsg:function(w){if(!this._receiveFlg){this._receiveMsgCache.push(w);return}var s={},v=this,x=w.isInit,u=arguments.callee,t;f(w.items,function(B,A){var z=B[0]+"",y=v.getUser(z);if(!y){v.getUserByVcard(z,{func:u,obj:v,param:[w]});t=true;return false}if(B[3]){y.updatePresence({uid:z,resource:r(B[3])})}s[z]?s[z].unreadMsg.push(B):s[z]={uid:z,unreadMsg:[B]};if(y.options.isFriend!=1||!(y.options.status=="hide"||y.options.status=="offline")){v.updateUser({uid:z})}v.updateActiveUsers(z);if(!x){v.updateRecents(z)}if(window.webkitNotifications){v.webkitNotify(B)}});if(t){return}_webim_log("newMsg",s);v.addUsersUnreadMsg(s,x)},updateRecents:function(t){var s=b(t,this._allRecents);(s!=-1)&&g.erase(this._allRecents,t);this._allRecents.unshift(t);e.fire("updateRecents",{uid:t})},updateActiveUsers:function(s){if(b(s,this._activeUsers)!=-1){g.erase(this._activeUsers,s)}this._activeUsers.push(s)},initUnreadMsgData:function(s){this._initUreadMsg=s},checkInitUnreadMsg:function(){var s=this;this._execUreadMsg(function(t){e.fire("chatWindow.init",{items:t});var u=s._receiveMsgCache;if(u.length>0){f(u.reverse(),function(w,v){s.execNewMsg(w)})}s.checkInitUnreadMsg=null})},getActiveUsers:function(){return([].concat(this._activeUsers)).reverse()},getHistoryMsg:function(s){this._client.reuqestHistoryMsg(s)},_execUreadMsg:function(w){var s=[],v=this,u=arguments.callee,t;this._receiveFlg=true;if(this._initUreadMsg){f(this._initUreadMsg,function(y,x){x+="";if(v._unreadObj[x]&&y==v._unreadObj[x].count){e.fire("cutUnreadCountEvent",{uid:x});return}if(!v.getUser(x)){v.getUserByVcard(x,{func:u,obj:v,param:[w]});this._receiveFlg=false;t=true;return false}s.push([x,y])});if(t){return}this.execNewMsg({type:"msg",items:s,isInit:true});this._initUreadMsg=null}w&&w(s)}};return h});STK.register("wbim.model.User",function(d){var c=d.wbim.ui,b=d.core.evt.custEvent,a=d.wbim.events.ui;function e(g){var f={uid:null,nick:"",status:null,group:null,avatar:null,isFriend:1,level:0,sex:1,resource:null,unreadMsg:[],historyMsg:[],unreadMsgCount:0};this.options=d.core.obj.parseParam(f,g);b.define(this,"historyMsg");b.define(this,"updateUnreadMsgCount");b.define(this,"updateStatus")}e.prototype={addEvent:function(g,f,h){b.add(this,g,f,h)},fireEvent:function(g,f){b.fire(this,g,f)},removeEvent:function(g,f){b.remove(this,g,f)},createUser:function(f){return new STK.wbim.ui.User(d.core.obj.parseParam({user:this,groupType:"",groupName:""},f))},createChatUser:function(){return new STK.wbim.ui.ChatUser({user:this})},addInitUreandMsg:function(f){if(f.unreadMsg&&f.unreadMsg.length>0){this.options.unreadMsgCount+=(f.unreadMsg[0][1]-0)}},addUnreadMsg:function(i){var g=this.options.unreadMsg,f=i.unreadMsg.concat(g),h=i.unreadMsg.length;this.options.unreadMsg=f;this.options.unreadMsgCount+=h;this.notify(h)},notify:function(f){a.fire("receivedMsg",{user:this,msgCount:f});this.fireEvent("updateUnreadMsgCount")},addHistoryMsg:function(f){this.options.historyMsg=f.msg;this.fireEvent("historyMsg");this.addHistoryMsg=null},clearUnreadMsg:function(){this.options.unreadMsg=[]},clearUnreadMsgCount:function(){var f=this.options.unreadMsgCount;if(f>0){this.options.unreadMsgCount=0;a.fire("cutUnreadCountEvent",{uid:this.options.uid,count:f});this.fireEvent("updateUnreadMsgCount")}},updatePresence:function(f){this.options=d.core.obj.parseParam(this.options,f);this.fireEvent("updateStatus")}};return e});(function(a){if(typeof dojo!=="undefined"){dojo.provide("org.cometd")}else{window.org=this.org||{};org.cometd={}}org.cometd.JSON={};org.cometd.AJAX={};org.cometd.JSON.toJSON=org.cometd.JSON.fromJSON=org.cometd.AJAX.send=function(b){throw"Abstract"};org.cometd.Cometd=function(T){var ad=T||"default";var at;var ae;var D;var ab;var N;var Y;var b=false;var u;var C="disconnected";var ah=0;var Z=null;var V=0;var ac=[];var c={};var S=0;var X=null;var M=[];var G={};var h;var B=false;function J(){return ad}function W(aA,aF,aE){var az=aF||{};for(var aC=2;aC<arguments.length;++aC){var aB=arguments[aC];if(aB===undefined||aB===null){continue}for(var aD in aB){var aG=aB[aD];if(aG===aF){continue}if(aG===undefined){continue}if(aA&&typeof aG==="object"&&aG!==null){az[aD]=W(aA,az[aD],aG)}else{az[aD]=aG}}}return az}function O(aA,aB){for(var az=0;az<aB.length;++az){if(aA==aB[az]){return az}}return -1}function H(aA,az){if(window.console){window.console[aA].apply(window.console,az)}}function e(){H("warn",arguments)}this._warn=e;function n(){if(at!="warn"){H("info",arguments)}}this._info=n;function ay(){if(at=="debug"){H("debug",arguments)}}this._debug=ay;function k(){return W({},new org.cometd.Transport("long-polling"),new org.cometd.LongPollingTransport())}function z(){return W({},new org.cometd.Transport("callback-polling"),new org.cometd.CallbackPollingTransport(ad))}function an(aA){var az=aA.supportedConnectionTypes;if(b){if(O("callback-polling",az)>=0){return u}}else{if(O("long-polling",az)>=0){return u}if(O("callback-polling",az)>=0){return z()}}return null}function aw(aA){ay("Configuring cometd object with",aA);if(typeof aA==="string"){aA={url:aA}}if(!aA){aA={}}ae=aA.url;if(!ae){throw"Missing required configuration parameter 'url' specifying the comet server URL"}D=aA.maxConnections||2;ab=aA.backoffIncrement||1000;N=aA.maxBackoff||60000;at=aA.logLevel||"info";Y=aA.reverseIncomingExtensions!==false;var az=/(^https?:)?(\/\/(([^:\/\?#]+)(:(\d+))?))?([^\?#]*)/.exec(ae);if(az[3]){b=az[3]!=window.location.host}if(b){u=z()}else{u=k()}ay("Initial transport is",u)}function t(){for(var aB in c){var aC=c[aB];for(var az=0;az<aC.length;++az){var aA=aC[az];if(aA&&aA.subscription){delete aC[az];ay("Removed subscription",aA,"for channel",aB)}}}}function ax(az){ay("Status",C,"->",az);C=az}function aj(){return C=="disconnecting"||C=="disconnected"}function f(){return ++ah}function aq(aA,aC,aB){try{return aC(aB)}catch(az){ay("Exception during execution of extension",aA,az);return aB}}function y(aC){for(var aB=0;aB<M.length;++aB){if(aC===undefined||aC===null){break}var aA=Y?M.length-1-aB:aB;var aE=M[aA];var aD=aE.extension.incoming;if(aD&&typeof aD==="function"){var az=aq(aE.name,aD,aC);aC=az===undefined?aC:az}}return aC}function d(aB){for(var aA=0;aA<M.length;++aA){if(aB===undefined||aB===null){break}var aD=M[aA];var aC=aD.extension.outgoing;if(aC&&typeof aC==="function"){var az=aq(aD.name,aC,aB);aB=az===undefined?aB:az}}return aB}function P(az){if(az===undefined){return[]}if(az instanceof Array){return az}if(az instanceof String||typeof az=="string"){return org.cometd.JSON.fromJSON(az)}if(az instanceof Object){return[az]}throw"Conversion Error "+az+", typeof "+(typeof az)}function ao(aD,aC){var aE=c[aD];if(aE&&aE.length>0){for(var aA=0;aA<aE.length;++aA){var aB=aE[aA];if(aB){try{aB.callback.call(aB.scope,aC)}catch(az){e("Exception during notification",aB,aC,az)}}}}}function ar(aD,aC){ao(aD,aC);var aE=aD.split("/");var aB=aE.length-1;for(var aA=aB;aA>0;--aA){var az=aE.slice(0,aA).join("/")+"/*";if(aA==aB){ao(az,aC)}az+="*";ao(az,aC)}}function j(aA,az){return setTimeout(function(){try{aA()}catch(aB){ay("Exception invoking timed function",aA,aB)}},az)}function s(){if(X!==null){clearTimeout(X)}X=null}function v(az){s();var aA=S;if(G.interval&&G.interval>0){aA+=G.interval}X=j(az,aA)}var am;var x;function I(aD,az){for(var aB=0;aB<aD.length;++aB){var aC=aD[aB];if(!aC.id){aC.id=f()}if(Z){aC.clientId=Z}aC=d(aC);if(aC!==undefined&&aC!==null){aD[aB]=aC}else{aD.splice(aB--,1)}}if(aD.length===0){return}var aA=this;var aE={url:ae,messages:aD,timeout:G.timeout+5000,onSuccess:function(aH,aG){try{am.call(aA,aH,aG,az)}catch(aF){ay("Exception during handling of response",aF)}},onFailure:function(aH,aI,aG){try{x.call(aA,aH,aD,aI,aG,az)}catch(aF){ay("Exception during handling of failure",aF)}}};ay("Send",aE);u.send(aE,az)}function U(az){if(V>0){ac.push(az)}else{I([az],false)}}function aa(){S=0}function af(){if(S<N){S+=ab}}function L(){++V}function F(az){--V;if(V<0){V=0}if(az&&V===0&&!aj()){var aA=ac;ac=[];if(aA.length>0){I(aA,false)}}}function q(){var az={channel:"/meta/connect",connectionType:u.getType()};ax("connecting");ay("Connect sent",az);I([az],true);ax("connected")}function w(){ax("connecting");v(function(){q()})}this.reconnect=function(){aa();w()};function r(aB){Z=null;t();V=0;L();h=W(true,{},aB);var az={version:"1.0",minimumVersion:"0.9",channel:"/meta/handshake",supportedConnectionTypes:b?["callback-polling"]:["long-polling","callback-polling"]};var aA=W({},aB,az);ax("handshaking");ay("Handshake sent",aA);I([aA],false)}function au(){ax("handshaking");v(function(){r(h)})}function Q(aB){if(aB.successful){Z=aB.clientId;var aA=an(aB);if(aA===null){throw"Could not agree on transport with server"}else{if(u.getType()!=aA.getType()){ay("Transport",u,"->",aA);u=aA}}aB.reestablish=B;B=true;ar("/meta/handshake",aB);var aC=G.reconnect?G.reconnect:"retry";switch(aC){case"retry":w();break;default:break}}else{var az=!aj()&&G.reconnect!="none";if(!az){ax("disconnected")}ar("/meta/handshake",aB);ar("/meta/unsuccessful",aB);if(az){af();au()}}}function A(aC,aB){var aA={successful:false,failure:true,channel:"/meta/handshake",request:aB,xhr:aC,advice:{action:"retry",interval:S}};var az=!aj()&&G.reconnect!="none";if(!az){ax("disconnected")}ar("/meta/handshake",aA);ar("/meta/unsuccessful",aA);if(az){af();au()}}function ak(az){var aA=aj()?"none":(G.reconnect?G.reconnect:"retry");if(!aj()){ax(aA=="retry"?"connecting":"disconnecting")}if(az.successful){F(true);ar("/meta/connect",az);switch(aA){case"retry":aa();w();break;default:aa();ax("disconnected");break}}else{switch(aA){case"retry":af();ar("/meta/connect",az);ar("/meta/unsuccessful",az);w();break;case"handshake":F(false);aa();ar("/meta/connect",az);ar("/meta/unsuccessful",az);au();break;case"none":aa();ax("disconnected");ar("/meta/connect",az);ar("/meta/unsuccessful",az);break}}}function K(aC,aA){var az={successful:false,failure:true,channel:"/meta/connect",request:aA,xhr:aC,advice:{action:"retry",interval:S}};ar("/meta/connect",az);ar("/meta/unsuccessful",az);if(!aj()){var aB=G.reconnect?G.reconnect:"retry";switch(aB){case"retry":af();w();break;case"handshake":aa();au();break;case"none":aa();break;default:ay("Unrecognized action",aB);break}}}function o(az){s();if(az){u.abort()}Z=null;ax("disconnected");V=0;ac=[];aa()}function ap(az){if(az.successful){o(false);ar("/meta/disconnect",az)}else{o(true);ar("/meta/disconnect",az);ar("/meta/usuccessful",az)}}function l(aB,aA){o(true);var az={successful:false,failure:true,channel:"/meta/disconnect",request:aA,xhr:aB,advice:{action:"none",interval:0}};ar("/meta/disconnect",az);ar("/meta/unsuccessful",az)}function av(az){if(az.successful){ar("/meta/subscribe",az)}else{ar("/meta/subscribe",az);ar("/meta/unsuccessful",az)}}function p(aB,aA){var az={successful:false,failure:true,channel:"/meta/subscribe",request:aA,xhr:aB,advice:{action:"none",interval:0}};ar("/meta/subscribe",az);ar("/meta/unsuccessful",az)}function g(az){if(az.successful){ar("/meta/unsubscribe",az)}else{ar("/meta/unsubscribe",az);ar("/meta/unsuccessful",az)}}function m(aB,aA){var az={successful:false,failure:true,channel:"/meta/unsubscribe",request:aA,xhr:aB,advice:{action:"none",interval:0}};ar("/meta/unsubscribe",az);ar("/meta/unsuccessful",az)}function E(az){if(az.successful===undefined){if(az.data){ar(az.channel,az)}else{ay("Unknown message",az)}}else{if(az.successful){ar("/meta/publish",az)}else{ar("/meta/publish",az);ar("/meta/unsuccessful",az)}}}function R(aB,aA){var az={successful:false,failure:true,channel:aA.channel,request:aA,xhr:aB,advice:{action:"none",interval:0}};ar("/meta/publish",az);ar("/meta/unsuccessful",az)}function ai(aA){if(aA.advice){G=aA.advice}var az=aA.channel;switch(az){case"/meta/handshake":Q(aA);break;case"/meta/connect":ak(aA);break;case"/meta/disconnect":ap(aA);break;case"/meta/subscribe":av(aA);break;case"/meta/unsubscribe":g(aA);break;default:E(aA);break}}this.receive=ai;am=function am(aE,aA,az){var aD=P(aA);ay("Received",aD);u.complete(aE,true,az);for(var aB=0;aB<aD.length;++aB){var aC=aD[aB];aC=y(aC);if(aC===undefined||aC===null){continue}ai(aC)}};x=function x(aA,aB,aE,az,aC){var aG=aA.xhr;ay("Failed",aB);u.complete(aA,false,aC);for(var aD=0;aD<aB.length;++aD){var aH=aB[aD];var aF=aH.channel;switch(aF){case"/meta/handshake":A(aG,aH);break;case"/meta/connect":K(aG,aH);break;case"/meta/disconnect":l(aG,aH);break;case"/meta/subscribe":p(aG,aH);break;case"/meta/unsubscribe":m(aG,aH);break;default:R(aG,aH);break}}};function i(aA){var aB=c[aA];if(aB){for(var az=0;az<aB.length;++az){if(aB[az]){return true}}}return false}function al(aE,aG,aF,aB){var aD=aG;var az=aF;if(typeof aG==="function"){aD=undefined;az=aG}else{if(typeof aF==="string"){if(!aG){throw"Invalid scope "+aG}az=aG[aF];if(!az){throw"Invalid callback "+aF+" for scope "+aG}}}ay("Listener scope",aD,"and callback",az);var aH={scope:aD,callback:az,subscription:aB===true};var aA=c[aE];if(!aA){aA=[];c[aE]=aA}var aC=aA.push(aH)-1;ay("Added listener",aH,"for channel",aE,"having id =",aC);return[aE,aC]}function ag(az){var aA=c[az[0]];if(aA){delete aA[az[1]];ay("Removed listener",az)}}this.configure=function(az){aw(az)};this.init=function(aA,az){aw(aA);r(az)};this.handshake=function(az){B=false;r(az)};this.disconnect=function(aB){if(!u){return}var az={channel:"/meta/disconnect"};var aA=W({},aB,az);ax("disconnecting");I([aA],false)};this.startBatch=function(){L()};this.endBatch=function(){F(true)};this.addListener=function(aA,az,aB){return al(aA,az,aB,false)};this.removeListener=function(az){ag(az)};this.clearListeners=function(){c={}};this.subscribe=function(aD,aA,aG,aF){if(typeof aA==="function"){aF=aG;aG=aA;aA=undefined}var aE=!i(aD);var aC=al(aD,aA,aG,true);if(aE){var az={channel:"/meta/subscribe",subscription:aD};var aB=W({},aF,az);U(aB)}return aC};this.unsubscribe=function(aD,aA){this.removeListener(aD);var aC=aD[0];if(!i(aC)){var az={channel:"/meta/unsubscribe",subscription:aC};var aB=W({},aA,az);U(aB)}};this.clearSubscriptions=function(){t()};this.publish=function(aC,aB,aD){var az={channel:aC,data:aB,id:f()};var aA=a.core.json.merge({},aD);var aA=a.core.json.merge(aA,az);U(aA);return az.id};this.getStatus=function(){return C};this.setBackoffIncrement=function(az){ab=az};this.getBackoffIncrement=function(){return ab};this.getBackoffPeriod=function(){return S};this.setLogLevel=function(az){at=az};this.registerExtension=function(az,aD){var aB=false;for(var aA=0;aA<M.length;++aA){var aC=M[aA];if(aC.name==az){aB=true;break}}if(!aB){M.push({name:az,extension:aD});ay("Registered extension",az);if(typeof aD.registered==="function"){aD.registered.call(aD,az,this)}return true}else{n("Could not register extension with name",az,"since another extension with the same name already exists");return false}};this.unregisterExtension=function(aA){var az=false;for(var aB=0;aB<M.length;++aB){var aD=M[aB];if(aD.name==aA){M.splice(aB,1);az=true;ay("Unregistered extension",aA);var aC=aD.extension;if(typeof aC.unregistered==="function"){aC.unregistered.call(aC)}break}}return az};this.getExtension=function(az){for(var aA=0;aA<M.length;++aA){var aB=M[aA];if(aB.name==az){return aB.extension}}return null};this.getName=function(){return ad};org.cometd.Transport=function(aF){var aD=0;var aE=null;var az=[];var aG=[];function aH(aI,aL){if(aE!==null){throw"Concurrent longpoll requests not allowed, request "+aE.id+" not yet completed"}var aK=++aD;var aJ={id:aK};aI._send(aL,aJ);aE=aJ}function aC(aI,aL){var aK=++aD;var aJ={id:aK};if(az.length<D-1){aI._send(aL,aJ);az.push(aJ)}else{aG.push([aL,aJ])}}function aB(aI){var aJ=aI.id;if(aE!==aI){throw"Comet request mismatch, completing request "+aJ}aE=null}function aA(aI,aK,aM){var aJ=O(aK,az);if(aJ>=0){az.splice(aJ,1)}if(aG.length>0){var aL=aG.shift();if(aM){aC(aI,aL[0])}else{setTimeout(function(){aL[0].onFailure(aL[1],"error")},0)}}}this._send=function(aJ,aI){throw"Abstract"};this.getType=function(){return aF};this.send=function(aJ,aI){if(aI){aH(this,aJ)}else{aC(this,aJ)}};this.complete=function(aJ,aK,aI){if(aI){aB(aJ)}else{aA(this,aJ,aK)}};this.abort=function(){for(var aI=0;aI<az.length;++aI){var aJ=az[aI];ay("Aborting request",aJ);if(aJ.xhr){aJ.xhr.abort()}}if(aE){ay("Aborting request",aE);if(aE.xhr){aE.xhr.abort()}}aE=null;az=[];aG=[]}};org.cometd.LongPollingTransport=function(){this._send=function(aA,az){az.xhr=org.cometd.AJAX.send({name:ad,transport:this,url:aA.url,headers:{Connection:"Keep-Alive"},body:org.cometd.JSON.toJSON(aA.messages),onSuccess:function(aB){aA.onSuccess(az,aB)},onError:function(aC,aB){aA.onFailure(az,aC,aB)}})}};org.cometd.CallbackPollingTransport=function(aA){var az=2005;this._send=function(aE,aD){var aC=org.cometd.JSON.toJSON(aE.messages);var aF=aE.url.length+encodeURI(aC).length;if(aF>az){var aB=aE.messages.length>1?"Too many bayeux messages in the same batch resulting in message too big ("+aF+" bytes, max is "+az+") for transport "+this.getType():"Bayeux message too big ("+aF+" bytes, max is "+az+") for transport "+this.getType();j(function(){aE.onFailure(aD,"error",aB)},0)}else{org.cometd.AJAX.send({name:aA,transport:this,url:aE.url,headers:{Connection:"Keep-Alive"},body:aC,timeout:typeof aE.timeout!=="undefined"?aE.timeout:null,onSuccess:function(aG){aE.onSuccess(aD,aG)},onError:function(aH,aG){aE.onFailure(aD,aH,aG)}})}}}}})(STK);(function(c){var j=window.org||{};j.cometd.JSON.toJSON=c.core.json.jsonToStr;j.cometd.JSON.fromJSON=c.core.json.strToJson;var h=false,i="_callback",e="parent.",d="org.cometd.script.";function a(){var l=j.cometd.script,k;h=true;if(!l.frame||!l.frame.contentWindow){return}k=l.frame.contentWindow.document.getElementsByTagName("script");for(var n=0,m=k.length;n<m;n++){try{k[n].parentNode.removeChild(k[n])}catch(o){}}if(j.disConnect){j.disConnect()}}function b(){if(typeof(window.CollectGarbage)==="function"){window.CollectGarbage()}if(!j.comet||!j.comet.connection){return}var k=j.comet.connection;if(j.comet.iframediv){j.comet.iframediv.innerHTML="";j.comet.iframediv=null}if(k.parentNode){k.parentNode.removeChild(k)}k=null;j.comet.connection=null;j.comet=null;j=null}function f(l,m){var k=l.url;if(k.indexOf("callback=?")==-1){k+="?jsonp="+m}else{k=k.replace("callback=?","callback="+m)}if(l.body){k+="&message="+encodeURIComponent(l.body)}k+="&"+(new Date-0);return k}function g(k){var m="cometd_"+k,l=document.getElementById(m);if(!l&&j.comet&&j.comet.connection){l=j.comet.connection.getElementById(m)}return l}c.core.evt.addEvent(window,"unload",function(k){a();b()});j.cometd.script={counter:0,frame:null,create:function(q,o){var l=this.counter++,m=i+l,s=q.timeout,t,p,n,r,k;if(!o&&q.name){this.frame=this.frame||g(q.name);t=this.frame.contentWindow.document}if(t){r=e+d}else{t=document;r=d}k=f(q,r+m);n=t.createElement("script");n.type="text/javascript";n.src=k;n.charset="utf-8";if(s&&s>0){p=setTimeout(function(){if(j.cometd.script[m]){j.cometd.script.remove(m,n);q.onError()}},s)}this[m]=this.bind(q.onSuccess,n,m,p);!h&&t.getElementsByTagName("head")[0].appendChild(n)},get:function(k,l){this.create(k,l)},remove:function(l,k){delete this[l];k.parentNode.removeChild(k,true)},bind:function(k,l,m,n){return function(o){_webim_log("org.cometd.script.bind",k,m,n,o);k(j.cometd.JSON.fromJSON(j.cometd.JSON.toJSON(o)));j.cometd.script.remove(m,l);n&&clearTimeout(n)}}};j.cometd.AJAX.send=function(m,l){var k=m.transport.getType();if(k=="long-polling"){return c.core.io.ajax({url:"packet.url",args:m.body,method:"POST",header:m.headers,onComplete:m.onSuccess,onFail:function(p,o,n){m.onError(o,n)}})}else{if(k=="callback-polling"){j.cometd.script.get(m,l)}else{throw"Unsupported transport "+k}}}})(STK);STK.register("wbim.io.LongConnect",function($){var $io_event=$.wbim.events.io;return function(param){var cfg=param.cfg||{},_client=param.clientCore,_istName=cfg.name||"uc",_cometd=null,_cometd_sub=null,_comet_server="",_comet_channel="",_status="unconnect",_cometCallback={},_reqCallback={},_requestId=0,_ratio=1,_reConnecting=false;var TIMEOUT=30000;var _Connect={_startConnect:function(){if(!_comet_channel||!_comet_server){_getServerInfo(function(){_Connect._connectCallback()})}},_connectCallback:function(){if(_cometd){_cometd.clearListeners();_cometd.clearSubscriptions();_Connect._disConnect()}_cometd=new org.cometd.Cometd("uc");_cometd.clearListeners();_cometd.clearSubscriptions();_cometd.init({url:_comet_server+"im"});_Connect._subChannel();_Connect._metaListen();_status="connected";_cmdKeeper.init();_client.initRequest();_reConnectChecker.start()},_subChannel:function(){_cometd_sub=_cometd.subscribe(_comet_channel,_Receive._comet_receive)},_unSubChannel:function(){_cometd_sub&&_cometd.unsubscribe(_cometd_sub);_cometd_sub=null},_metaListen:function(){_cometd.addListener("/meta/handshake",this._metaHandshake);_cometd.addListener("/meta/connect",this._metaConnect);_cometd.addListener("/meta/publish",this._metaPublish)},_metaHandshake:function(e){if(e.reestablish&&e.successful){_Connect._subChannel()}},_metaConnect:function(e){if(e.failure&&_status!="connecting"){_status="disconnect";_Connect._tryReConnect()}},_metaPublish:function(e){if((e.failure===true||e.successful===false)&&_status!="connecting"){_status="disconnect";_Connect._tryReConnect()}},_reConnectTimes:0,_tryReConnect:function(){if(this._reConnectTimes++<5&&_status!="connecting"){_status="connecting";_Connect._reConnect()}},_reConnect:function(){if(_reConnecting){return}_reConnecting=true;_comet_channel=_comet_server="";_Connect._startConnect();$.wbim.events.io.fire("reconnecting");setTimeout(function(){_reConnecting=false},TIMEOUT)},_disConnect:function(){if(_cometd){_Connect._unSubChannel();_cometd.disconnect()}}};org.disConnect=_Connect._disConnect;var _cmdKeeper={cmds:[],tmpCmds:[],timeout:null,init:function(){this.tmpCmds=this.cmds;this.cmds=[];this.timeout&&clearTimeout(this.timeout);this.timeout=null},keep:function(id,data){this.timeout&&clearTimeout(this.timeout);this.timeout=setTimeout(function(){_Connect._reConnect()},8000);this.cmds.push({id:id,data:data,timeout:this.timeout})},free:function(reqId){for(var i=0;this.cmds[i];i++){cmdObj=this.cmds[i];if(reqId==cmdObj.id){clearTimeout(cmdObj.timeout);this.cmds.splice(i,1);break}}},isReady:function(){return !(this.tmpCmds.length)},sendTmpCmds:function(){var cmds=this.tmpCmds;this.tmpCmds=[];_webim_log("_cmdKeeper sendTmpCmds",cmds);for(var i=0;cmds[i];i++){_Request._request.apply(null,cmds[i].data)}}};var _Request={_request:function(cmd,params,cb,flg){params=_Request._packageCmd(cmd,params,cb,flg);if(!flg){_cmdKeeper.keep(_requestId,[cmd,params,cb,flg]);if(!_cmdKeeper.isReady()){return}}if(_status=="connected"){_Request._publish(params)}else{_Connect._reConnect()}},_requestBatch:function(cmdArray){_cometd.startBatch();for(var i=0;cmdArray[i];i++){var o=cmdArray[i];_Request._request(o.cmd,o.params,o.cb,true)}_cometd.endBatch()},_publish:function(data){var publishId=_cometd.publish("/im/req",data);_cometCallback[publishId]={callbackId:_requestId}},_packageCmd:function(cmd,params,cb,flg){params=params||{};params.cmd=cmd;++_requestId;flg?((_requestId%2==0)&&++_requestId):((_requestId%2!=0)&&++_requestId);_webim_log("_request",cmd,params,cb,flg,_requestId,_status);if(cb){_reqCallback[_requestId]=function(p){cb(p)}}return params}};var _reConnectChecker={timeReconnect:5*30*1000,start:function(){this._connectTimeout&&clearTimeout(this._connectTimeout);this._connectTimeout=setTimeout(function(){_Connect._reConnect()},this.timeReconnect)},clear:function(){this._connectTimeout&&clearTimeout(this._connectTimeout);this._connectTimeout=null}};var _Receive={_comet_receive:function(o){var data=o.data,cb=_cometCallback[o.id],reqId=cb?cb.callbackId:null,cmdObj;_webim_log("_comet_receive：",reqId,o);if(reqId){if(reqId%2==0){_cmdKeeper.free(reqId)}else{if(!_cmdKeeper.isReady()){_cmdKeeper.sendTmpCmds()}}if(_reqCallback[reqId]){_reqCallback[reqId](data);_reqCallback[reqId]=null}}if(o.data){$.wbim.events.io.fire("comet_receive",o)}_reConnectChecker.start()}};function _getServerInfo(cb){if(!$.wbim.utils.Core.getCurrentUIDByCookie()){_comet_server=_comet_channel="";return}var connected=false;var url="http://nas.im.api.weibo.com/im/webim.jsp?v=1.1&returntype=json&product="+(cfg.product?cfg.product:"")+"&uid="+$.wbim.$currentUID+"&callback=?";_webim_log("_getServerInfo:",url,cb);org.cometd.AJAX.send({transport:{getType:function(){return"callback-polling"}},name:"uc",url:url,onSuccess:function(r){_webim_log("_getServerInfo onSuccess",r);if(r&&r.channel){if(!_comet_server&&!_comet_channel){_comet_server=r.server;_comet_channel=r.channel;connected=true;_reConnectChecker.clear();cb();_ratio=1}}else{_status="disconnect";_comet_server=_comet_channel=""}}},true);setTimeout(function(){if(!connected){_getServerInfo(cb)}},TIMEOUT*_ratio);(_ratio<10)&&_ratio++}(function(){var comet={};if(navigator.appVersion.indexOf("MSIE")!=-1&&!$.core.util.browser.IE9){comet.connection=new ActiveXObject("htmlfile");comet.connection.open();comet.connection.write("<html>");comet.connection.write("</html>");comet.connection.close();comet.iframediv=comet.connection.createElement("div");comet.connection.appendChild(comet.iframediv);comet.connection.parentWindow.comet=comet;comet.connection.parentWindow.org=org;comet.iframediv.innerHTML='<iframe id="cometd_'+_istName+'" name="cometd_'+_istName+'"></iframe>'}else{if(navigator.appVersion.indexOf("KHTML")!=-1){comet.connection=document.createElement("iframe");comet.connection.setAttribute("id","cometd_"+_istName);with(comet.connection.style){position="absolute";left=top="-100px";height=width="1px";visibility="hidden"}document.body.appendChild(comet.connection)}else{comet.connection=document.createElement("iframe");comet.connection.setAttribute("id","cometd_"+_istName);with(comet.connection.style){left=top="-100px";height=width="1px";visibility="hidden";display="none"}comet.iframediv=document.createElement("iframe");comet.connection.appendChild(comet.iframediv);document.body.appendChild(comet.connection)}}org.comet=comet})();return{startConnect:_Connect._startConnect,reConnect:_Connect._reConnect,request:_Request._request,requestBatch:_Request._requestBatch}}});STK.register("wbim.io.Server",function(d){var g=d.wbim.utils.date,a=d.wbim.utils.Array,f=d.wbim.events.ui,e=d.wbim.events.io,c=d.wbim.SyncStorage,b=d.WBIM.language;d.wbim.userData=new d.wbim.model.UserData();return function(n){var k=this,s,l=b("#L{很抱歉，根据相关法规和政策，此内容无法发布。如需帮助请联系@微博客服或者致电客服电话400 690 0000}"),h,i=d.wbim.userData,j=new d.wbim.io.LongConnect({cfg:n,clientCore:k}),m=d.wbim.io.SyncData,o=[{cmd:"roster",params:{online:"1",limit:"2000"}},{cmd:"querypresence"}];i.setClient(k);var t={_requestVcard:function(v,u){j.request("vcard",v,u)},_requestSelfPresence:function(v,u){j.request("presence",{status:v.status},u)},_requestSendMsg:function(u){h=u.uid;j.request("msg",u)},_requestSearchUsers:function(w,u){var v={key:null,limit:20};j.request("roster_search",d.core.obj.parseParam(v,w),u)},_reuqestHistoryMsg:function(v,u){var u=u||function(w){r._receiveHistoryMsg({uid:v.uids+"",msg:w.items})};j.request("chat_msg_history",v,u)},_requestRevmsg:function(v,u){j.request("revmsg",v,u,true)},_requestInTextarea:function(v,u){j.request("chatStates",v,u)},_requestSynchroniz:function(v,u){j.request("synchroniz",v,u)},_requestInitData:function(){j.requestBatch(o)}};var r={_receive:function(v){var u=v.data;var w="_receive_"+(u.type||v.type);if(r[w]){r[w](u)}},_receive_presence:function(u){if(!u.items){return}i.updateUsersPresence(u.items)},_receive_msg:function(u){if(u.items){i.execNewMsg(u)}else{if(u.ret==0){i.updateRecents(h)}else{if(u.ret==408){e.fire("notSend2User",{uid:h})}else{if(u.ret==406){e.fire("userIsForbidden",{msg:u.errMsg||l})}}}}},_receive_chatStates:function(u){if(u.items){f.fire("addChartInputing",u.items[0])}},_receive_pauseChat:function(u){if(u.items){f.fire("stopInputing",u.items[0])}},_receive_unreader:function(u){if(u.items.total>0){delete u.items.total;i.initUnreadMsgData(u.items)}},_receive_roster:function(u){window.__PubSub__.publish("webim.connected");if(!d.wbim.$baseServerTime){d.wbim.$baseServerTime=u.timestamp;g.startTiming()}s.renderUI(u.items.length+u.recents.length);i.initUsers(u)},_receive_rosterremove:function(u){i.removeRoster(u.uid+"")},_receive_rosterupdate:function(v){var u={};delete v.type;u.uid=v.uid+"";u.user=v;i.updateUser(u);i.updateRelation(u.uid,"1")},_receive_querypresence:function(v){var u=v.items;if(u.length===0){return}i.setSelfUid({uid:u[0]+""});i.setSelfStatus({status:u[1]})},_receiveHistoryMsg:function(u){if(u.msg.length===0){return}i.addUserHistoryMsg(u)},_receive_roster_search:function(u){i.addSearchedUsers(u.items)},_receive_synchroniz:function(u){if(u.rev!=undefined&&u.rev=="0"){return}m.receive(u.syncData)},_receive_shutdown:function(){j.reConnect()}};this.allowStart=true;var p=this;this.changeAllowStart=function(){p.allowStart=false;setTimeout(function(){p.allowStart=true},1000)};this.getVcardInfo=function(u,v){t._requestVcard(u,v)};this.selfPresence=function(v,u){t._requestSelfPresence(v,u)};this.sendMsg=function(u){t._requestSendMsg(u)};this.requestRevmsg=function(v,u){t._requestRevmsg(v,u)};this.reuqestHistoryMsg=function(v,u){t._reuqestHistoryMsg(v,u)};this.initRequest=function(){t._requestInitData()};var q=function(){if(!k.allowStart){return}k.changeAllowStart();j.startConnect();m.add("dispatch",function(v,w,u){t._requestSynchroniz(w,u)});d.core.evt.addEvent(window,"beforeunload",function(u){c.writeLastTime()})};c.init();e.add("comet_receive",function(u){r._receive(arguments[1])});f.add("requestInTextarea",function(u,v){t._requestInTextarea(v)});f.add("search",function(u,v){t._requestSearchUsers({key:v.keyword})});s=new d.wbim.ui.Core();q()}});STK.register("wbim.ui.StatusManage",function(g){var d=g.WBIM.language,b=g.wbim.io.SyncData,f=g.wbim.events.ui,a=g.core.dom.sizzle,c=d(['<div node-type="status_manager">','<div class="tit">','<span class="wbim_status_online"></span><span class="txt">#L{在线}</span><span class="icon"></span>',"</div>",'<div class="linert"></div>',"<ul>",'<li class="lingtop"></li>',"<li>",'<a href="javascript:void(0)"><span class="wbim_status_online"></span>#L{在线}</a>',"</li>","<li>",'<a href="javascript:void(0)"><span class="wbim_status_busy"></span>#L{忙碌}</a>',"</li>","<li>",'<a href="javascript:void(0)"><span class="wbim_status_away"></span>#L{离开}</a>',"</li>","<li>",'<a href="javascript:void(0)"><span class="wbim_status_offline"></span>#L{隐身}</a>',"</li>","</ul>","</div>"].join("")),e={online:d("#L{在线}"),busy:d("#L{忙碌}"),away:d("#L{离开}"),offline:d("#L{隐身}")};function h(){this.root=g.core.dom.builder(c).list.status_manager[0];this.statusNode=g.core.dom.sizzle(".tit span",this.root)[0];this.statusTxtNode=g.core.dom.sizzle(".tit .txt",this.root)[0];this.statusListNode=g.core.dom.sizzle("ul",this.root)[0];this.statusListNode.style.display="none";this._bindDataEvents();this._bindDomEvents();c=null}h.prototype={render:function(i){i&&i.appendChild(this.root)},_bindDomEvents:function(){var j=this,i=g.core.evt.addEvent;i(this.root,"mouseover",function(){j.showStatusListNode()});i(this.root,"mouseout",function(){j.hideStatusListNode()});g.core.arr.foreach({online:"online",busy:"busy",away:"away",offline:"hide"},function(k,l){var m=a("ul .wbim_status_"+l,j.root)[0].parentNode;i(m,"click",function(){b.dispatch("StatusManager.changeStatus",k);f.fire("selfChangeStatus",{status:k});j.hideStatusListNode();return false})})},_bindDataEvents:function(){var i=this;f.add("selfStatus",function(j,k){i._changeStatus(k.status)});f.add("selfChangeStatus",function(j,k){i._changeStatus(k.status)});b.add("StatusManager.changeStatus",function(k,j){f.fire("selfChangeStatus",{status:j})})},_changeStatus:function(i){if(i==="hide"){i="offline"}this.statusTxtNode.innerHTML=e[i];this.statusNode.className="wbim_status_"+i},showStatusListNode:function(){this.root.parentNode.className="wbim_tit_lf wbim_tit_lf_hover";this.statusListNode.style.display="block";this.statusListNode.style.visibility="visible";this.hidden=false},hideStatusListNode:function(){this.root.parentNode.className="wbim_tit_lf";this.statusListNode.style.display="none";this.statusListNode.style.visibility="hidden";this.hidden=true}};return h});STK.register("wbim.ui.GuidePop",function(c){var e=c.wbim.events.ui,b=c.core.evt.addEvent,d=c.WBIM.language(['<div style="bottom:30px;left:-220px;display:none;z-index:1002" class="layer_tips layer_tips_version" node-type="guide_pop">','<div class="layer_tips_bg">',"<ul>","<li>#L{新私信提醒搬到这啦，在这里还可以快速进入<strong>私信聊天模式</strong>哦！}</li>",'<li class="link_btn"><a href="javascript:void(0)" class="wbim_btn_c"><em>#L{知道了}</em></a></li>',"</ul>",'<span class="arrow_down" style="left:26px"></span>',"</div>","</div>"].join(""));function a(){this.root=c.core.dom.builder(d).list.guide_pop[0];this.closeBT=c.core.dom.sizzle(".wbim_btn_c",this.root)[0];this._bindDataEvents();this._bindDomEvents();this.Guided=false}a.prototype={render:function(f){if(!f){f=c.E("wbim_box")}f&&f.appendChild(this.root)},show:function(){if(!this.Guided){this.root.style.display=""}},close:function(){if(this.Guided){return}c.core.io.jsonp({url:"http://weibo.com/aj/im/closetips?_t=1&type=6&uid="+c.wbim.$currentUID,varkey:"_v"});this.hide();this.Guided=true},hide:function(){this.root.style.display="none"},_bindDomEvents:function(){var f=this;b(this.closeBT,"click",function(){f.close()})},_bindDataEvents:function(){var f=this;e.add("OnlineBar.OnClick",function(){f.close()});e.add("realCloseChatWindow",function(){f.show()});e.add("activeChatUser",function(){f.hide()});e.add("miniChatWindow",function(){f.show()})}};return a});STK.register("wbim.ui.OnlineBar",function(c){var i=c.WBIM.language,m=c.wbim.events.ui,b=c.core.dom,e=b.sizzle,r=c.core.evt.addEvent,l=c.wbim.userData,q=b.addClassName,d=b.hasClassName,f=b.removeClassName,o=c.core.str.leftB,a="wbim_min_chat_msg",k="wbim_min_box_col2",j="wbim_min_box_col3",g=i("#L{聊天中}"),h=i("#L{你有N条新私信}"),n=i(['<div class="wbim_min_friend">','<p class="statusbox">','<span class="wbim_status_online"></span>',"</p>",'聊天(<span class="wbim_online_count">0</span>)',"</div>",'<div class="wbim_min_line wbim_min_linefor3"></div>','<div class="wbim_min_chat">','<span class="wbim_icon_msg"></span><span class="wbim_min_text_pre">#L{正与} </span>','<span class="wbim_min_nick"></span><span class="line"></span><span class="wbim_min_text"></span>',"</div>"].join(""));function p(){this.root=c.C("DIV");this.root.className=k;this.root.style.cssText="position:absolute;bottom:0px;right:0px;";this.box=c.C("DIV");this.box.className="wbim_min_box";b.insertHTML(this.box,n);this.root.appendChild(this.box);this.countDOM=e(".wbim_online_count",this.root)[0];this.chatNode=e(".wbim_min_chat",this.root)[0];this.nickNode=e(".wbim_min_nick",this.root)[0];this.preTextNode=e(".wbim_min_text_pre",this.root)[0];this.textNode=e(".wbim_min_text",this.root)[0];this.statusNode=e(".wbim_status_online",this.root)[0];this.msgCount=0;this.unreadUids=[];this.activeUID;this._bindDomEvent();this._bindDataEvent();this.guidePop;this.rendered;n=null;var s=this;c.core.io.jsonp({url:"http://weibo.com/aj/im/gettips?_t=1&uid="+c.wbim.$currentUID,varkey:"_v",onComplete:function(t){if(t&&t.code==="100001"){s.guidePop=new c.wbim.ui.GuidePop();s.guidePop.render();if(s.rendered){s.guidePop.show()}}else{c.wbim.ui.GuidePop=null}}})}p.prototype={render:function(s){s.appendChild(this.root);this.guidePop&&this.guidePop.show();this.rendered=true},_bindDomEvent:function(){var t=this;var s=e(".wbim_min_friend",this.root)[0];r(s,"click",function(){m.fire("OnlineBar.OnClick")});r(s,"mouseover",function(){s.className="wbim_min_friend wbim_min_box_hover"});r(s,"mouseout",function(){s.className="wbim_min_friend"});r(t.chatNode,"mouseover",function(){if(t.chatNode.className.indexOf("wbim_min_chat_msg")===-1){t.chatNode.className="wbim_min_chat wbim_min_box_hover"}});r(t.chatNode,"mouseout",function(){if(t.chatNode.className.indexOf("wbim_min_chat_msg")===-1){t.chatNode.className="wbim_min_chat"}});r(this.chatNode,"click",function(){m.fire("contactsPanel.userClicked",{uid:t.activeUID,activeUsers:l.getActiveUsers()});t.guidePop&&t.guidePop.close()})},_bindDataEvent:function(){var s=this;s.count=0;window.__PubSub__.subscribe("webim.messageTipClicked",function(){m.fire("contactsPanel.userClicked",{uid:s.activeUID,activeUsers:l.getActiveUsers()})});m.add("updateOnlineUserCount",function(t,u){s.countDOM.innerHTML=u.count;if(u.incremental){s.countDOM.innerHTML=s.count+u.incremental;s.count=s.count+u.incremental}});m.add("selfStatus",function(t,u){s._changeStatus(u.status)});m.add("selfChangeStatus",function(t,u){s._changeStatus(u.status)});m.add("receivedMsg",function(u,t){s.msgCount+=t.msgCount;s.notifyNewMsg();s.activeUID=s.activeUID||l.getActiveUsers()[0]});m.add("afterUpdateUnreadMsgCount",function(t,u){if(u.isActived()){s.msgCount-=u.getOpt().unreadMsgCount;s.fireListenerUnreadMsgCount()}});m.add("activeChatUser",function(t,u){s.msgCount-=u.getOpt().unreadMsgCount;s.activeUID=u.getUID();s.chatWithActiveUser()});m.add("closeChatUser",function(t,u){s.msgCount-=u.getOpt().unreadMsgCount;s.fireListenerUnreadMsgCount()});m.add("chatWindow.hide2Bar",function(u,t){s.activeUID=t;if(l.getActiveUsers().length==0||s.msgCount<1){s.chatWithActiveUser()}else{if(s.msgCount>0){s.notifyNewMsg()}}});m.add("realCloseChatWindow",function(t){s.msgCount=0;s.hideMinChat();s.fireListenerUnreadMsgCount()})},fireListenerUnreadMsgCount:function(){if(this.msgCount>=0){window.__PubSub__.publish("webim.showMessage",this.msgCount)}},chatWithActiveUser:function(){f(this.chatNode,a);this._flashTimes=6;this.showPreText();this.nickNode.innerHTML=o(l.getUser(this.activeUID).options.nick,10);this.textNode.innerHTML=g;this.showMinChat();this.fireListenerUnreadMsgCount()},notifyNewMsg:function(){this.hidePreText();this.nickNode.innerHTML=h.replace("N",this.msgCount);this.textNode.innerHTML="";this.showMinChat();this.flashTips();this.fireListenerUnreadMsgCount()},showMinChat:function(){!d(this.root,j)&&(this.root.className=j)},hideMinChat:function(){this.activeUID="";this.root.className=k},showPreText:function(){b.setStyle(this.preTextNode,"display","inline")},hidePreText:function(){b.setStyle(this.preTextNode,"display","none")},flashTips:function(s){var t=this;if(!s){q(t.chatNode,a);t._flashTimes=0}else{if(t._flashTimes++>5){return}t._flashTimes%2?f(t.chatNode,a):q(t.chatNode,a)}setTimeout(function(){t.flashTips(true)},500)},_changeStatus:function(s){if(s==="hide"){s="offline"}this.statusNode.className="wbim_status_"+s}};return p});STK.register("wbim.ui.Core",function(d){var b=d.wbim.ui,g=d.wbim.events.ui,a=d.wbim.io.SyncData,f=d.wbim.userData,c=d.wbim.SyncStorage;function e(h){this.initUI();this.bind_events()}e.prototype={initUI:function(){this._root=d.E("wbim_box");c.closeWrite();this._contacts=new b.ContactsPanel();this._chatWindow=new b.ChatWindow();this._onlineBar=new b.OnlineBar();new b.MsgIndicator();c.openWrite()},renderUI:function(h){if(this.rendered){return}this.rendered=true;this._contacts.render(this._root,h);this._chatWindow.render(this._root);this._onlineBar.render(this._root);this.bindDomEvent()},bind_events:function(){var h=this;g.add("groupsDataReady",function(j,i){h._onlineBar.msgCount=0;h._contacts.initGroups(i);h.initByStorage&&h.initByStorage(h)})},bindDomEvent:function(){var h=this;d.core.evt.addEvent((document.body||document.documentElement),"click",function(j){j=j||window.event;var i=j.target||j.srcElement;if(i.getAttribute("action-type")!="webim.conversation"&&!d.core.dom.contains(d.sizzle("#wbim_box")[0],i)){if(h._chatWindow.isOpen()){g.fire("miniChatWindow");a.dispatch("chatWindow.hide")}if(h._contacts.isOpen()){h._contacts.hide();a.dispatch("contactsPanel.display",false)}}})},initByStorage:function(l){var k=c.read("chatWindow"),j=arguments.callee,o=function(){c.openWrite();f.checkInitUnreadMsg();a.enable();o=null},i=true,p,h,m,n;if(k===undefined){setTimeout(function(){_webim_log("swf no ready!");j(l)},500);return}if(k){h=c.read("wbim_timestamp").lastTime;i=(!h||(+(new Date())-parseInt(h))>50000);n=c.read("sendButton");if(n.enter!==undefined){g.fire("sendButtonChange",n.enter)}if(i){_webim_log("beyond 30s",(+(new Date())),h);c.writeLastTime();c.write("chatWindow",{});c.write("contactsPanel",{})}else{p=c.read("contactsPanel");c.closeWrite();if(p.openFlg){l._contacts.show()}l._chatWindow.initByStorage(k,o)}}if(i){o();l._chatWindow.initByStorage=null}l.initByStorage=null}};return e});STK.register("wbim.ui.User",function(d){var f=d.wbim.events.ui,a=d.core.dom.sizzle,c={},b=d.core.util.templet,e='<div class="wbim_userhead"><img imgsrc="http://tp#{imgserv}.sinaimg.cn/#{uid}/30/#{avatar}/#{sex}"><span class="wbim_icon_msg_s" style="display:#{_display};"></span><span class="wbim_status_online"></span></div><div class="wbim_username">#{nick}</div>';function g(h){var j={groupType:"",groupName:"",user:null};this.options=d.core.obj.parseParam(j,h);this.user=this.options.user;var i=this.user.options;i._display=i.unreadMsgCount>0?"":"none";i.imgserv=i.uid%4+1;this.root=d.C("LI");this.root.setAttribute("uid",i.uid);this.root.title=i.nick;i.nick=i.nick?i.nick:i.uid;this.root.innerHTML=b(e,i);this.root.setAttribute("action-type","User.Onclick");this.root.setAttribute("action-data","uid=UID&groupName=GN".replace("UID",i.uid).replace("GN",this.options.groupName));this.statusNode=a(".wbim_status_online",this.root)[0];this.noticeNode=a(".wbim_icon_msg_s",this.root)[0];this.bindDataEvent();this._checkStatus();this.updataOnlineCount()}g.prototype={bindDataEvent:function(){var h=this;this.bindFn1=function(){h.notifyNewMsg()};this.bindFn2=function(){h._checkStatus();h._notifyGroup();h.updataOnlineCount()};this.user.addEvent("updateUnreadMsgCount",this.bindFn1);this.user.addEvent("updateStatus",this.bindFn2)},updataOnlineCount:function(){var j=this.user.options,h=j.status,i=j.uid;if(h!="offline"&&h!="hide"){if(!c[i]){c[i]=true;f.fire("updateOnlineUserCount",{incremental:1})}}else{if(c[i]){delete c[i];f.fire("updateOnlineUserCount",{incremental:-1})}}},_checkStatus:function(){var k=this.user.options,h=k.status,j=k.resource;this._status=this._status||"online";if(h=="hide"){h="offline"}if(this._status!=h||this._resource!=j){var i="wbim_status_"+h;if(j=="mobile"&&h!="offline"){i="wbim_status_mobile"}if(j=="desktop"&&h!="offline"){i="wbim_status_client"}this.statusNode.className=i;this.root.className=(h=="offline")?"wbim_offline":"";this._status=h;this._resource=j}},_notifyGroup:function(){var i=this.user.options,h=this.options.groupType;if(this._status=="offline"){if(h=="online"){f.fire("onlineUser.offline",{uid:i.uid.toString(),groupName:this.options.groupName})}}else{if(h=="online"||(h=="recents"&&i.isFriend==1)){f.fire("onlineUser.online",{uid:i.uid.toString(),groupName:this.options.groupName})}}},notifyNewMsg:function(){this.noticeNode.style.display=this.user.options.unreadMsgCount>0?"":"none"},updateImg:function(){var h=a("img",this.root)[0];h.setAttribute("src",h.getAttribute("imgsrc"))},remove:function(){this.user.removeEvent("updateUnreadMsgCount",this.bindFn1);this.user.removeEvent("updateStatus",this.bindFn2);this.root.parentNode.removeChild(this.root);this.root=null;this.updataOnlineCount()}};return g});STK.register("wbim.ui.UserGroup",function(f){var d=f.WBIM.language,n=f.wbim.userData,a=f.wbim.utils.Array,b=f.wbim.utils.LazyLoader,o=f.wbim.events.ui,g=f.core.dom.sizzle,j=f.core.dom.insertElement,c=f.core.str.leftB,m=f.core.arr.foreach,k=f.core.dom.removeClassName,i=f.core.dom.addClassName,e="#{title}[<span>0</span>]";function h(q){var p=this.uidlist.length;q=q.toString();if(this.users[q]){if(this.uidlist[p-1]!=q){j(this.listNode,this.listNode.removeChild(this.users[q].root),"afterbegin")}}else{if(p==10){this.removeUser(this.uidlist[0])}this.addUser(q)}}function l(r){var p={id:"",type:"",title:"",container:null},q;this.options=f.core.obj.parseParam(p,r);q=this.options.title;this.uidlist=[];this.users={};this.lazyLoad=new b({prop:"imgsrc",container:this.options.container,sltImg:".wbim_userhead img",queue:false,area:false});this.root=f.C("DIV");this.root.className="wbim_list_group";this.titleNode=f.C("DIV");this.titleNode.className="wbim_list_group_tit";this.titleNode.title=q;this.titleNode.innerHTML=f.core.util.templet(e,{title:(q.length>10)?c(q,10)+"...":q});this.countNode=g("span",this.titleNode)[0];this.listNode=f.C("ul");this.root.appendChild(this.titleNode);this.root.appendChild(this.listNode);this._bindDomEvents();this._bindDataEvents();if(this.options.type=="recents"){this.sort=h;h=null}this.rendered;this.hideUsers()}l.prototype={render:function(p){p.appendChild(this.root);this.rendered=true},_bindDataEvents:function(){var p=this,q=this.options.id;if(this.options.type=="online"){o.add("onlineUser.offline",function(s,r){if(r.groupName==q){p.removeUser(r.uid)}});o.add("onlineUser.online",function(s,r){if(r.groupName==q){p.addUser(r.uid)}})}},_bindDomEvents:function(){var p=this;f.core.evt.addEvent(this.titleNode,"click",function(){p[p._showed?"hideUsers":"showUsers"]();p.lazyLoad.check();return false})},getUserCount:function(){if(this.options.type=="recents"&&this.uidlist.length>10){return 10}return this.uidlist.length},updateUserCount:function(){this.countNode.innerHTML=this.getUserCount()},showUsers:function(){k(this.titleNode,"wbim_close");i(this.titleNode,"wbim_open");this.listNode.style.display="";this._showed=true},hideUsers:function(){k(this.titleNode,"wbim_open");i(this.titleNode,"wbim_close");this.listNode.style.display="none";this._showed=false},createUser:function(q){q=q.toString();var p=n.getUser(q);if(p){return p.createUser({groupName:this.options.id,groupType:this.options.type})}},addUser:function(q,r){q=q.toString();if(this.users[q]){return}var s=this;r=r||function(t){j(s.listNode,t.root,"afterbegin")};var p=this.createUser(q);if(p){this.users[q]=p;this.uidlist.push(q);r(p)}this.updateUserCount()},addUsers:function(r){var q=this,p=document.createDocumentFragment();m(r,function(t,s){q.addUser(t,function(u){p.appendChild(u.root)})});this.listNode.appendChild(p);this.updateUserCount()},clearUsers:function(){var p=this;m([].concat(this.uidlist),function(r,q){p.removeUser(r)})},removeUser:function(p){p=p.toString();if(this.users[p]){this.users[p].remove();delete this.users[p];a.erase(this.uidlist,p);this.updateUserCount()}},remove:function(p){p.removeChild(this.root);this.rendered=false},isRendered:function(){return this.rendered},getUser:function(p){return this.users[p]}};return l});STK.register("wbim.ui.ContactsPanel",function(h){var c=h.WBIM.language,n=h.wbim.events.ui,e=h.wbim.events.io,i=h.core.dom.sizzle,o=h.wbim.userData,j=h.wbim.io.SyncData,l=h.wbim.events.io,m=h.core.arr.foreach,a=h.wbim.utils.Array,g="online",d="recentsusernogroup",p=c("#L{我的好友}"),k=c("#L{最近联系人}");var f=c('<div class="wbim_list_con"><div class="wbim_tit"><div class="wbim_titin"><div class="wbim_tit_lf"></div><div class="wbim_tit_rt"><a class="wbim_icon_setup" target="_blank" title="#L{设置}" href="http://weibo.com/settings/notice#webim"></a><a target="_blank" href="http://weibo.com/webim" title="#L{意见反馈}" class="wbim_icon_fk"></a><a href="javascript:void(0)" class="wbim_icon_mini" title="#L{最小化}" hidefocus="true"></a></div></div></div><div class="wbim_line"></div><div class="wbim_list_srch"></div><div class="wbim_list_box"><div class="wbim_list_friend"></div></div><div class="wbim_list_pos"><a class="wbim_clicknone" hidefocus="true" href="javascript:void(0)"><span class="wbim_icon_arrd"></span></a></div></div>');function b(q){this.groups={};this.root=h.C("DIV");this.root.className="wbim_list_expand";this.root.innerHTML=f;this.root.style.cssText="display:none;z-index:1001;right:0px;bottom:0px;";this.listBox=i(".wbim_list_box",this.root)[0];this.searchNode=i(".wbim_list_srch",this.root)[0];this.groupParentNode=i(".wbim_list_friend",this.root)[0];this.closeNode=i(".wbim_icon_mini",this.root)[0];this.closeNode2=i(".wbim_clicknone",this.root)[0];this.feedbackNode=i(".wbim_icon_fk",this.root)[0];this.configNode=i(".wbim_icon_setup",this.root)[0];this.statusManage=new h.wbim.ui.StatusManage();this._openFlg;this._bindDomEvent();this._bindDataEvent();this._openFlg}b.prototype={render:function(q,s){q.appendChild(this.root);this.statusManage.render(i(".wbim_tit_lf",this.root)[0]);var r=this;if(s>0){this._bindUISyncEvent();var u=h.core.evt.delegatedEvent(this.groupParentNode);u.add("User.Onclick","click",function(w){n.fire("contactsPanel.userClicked",{uid:w.data.uid})});if(h.core.util.browser.IE6){var v=h.core.dom.removeClassName,t=h.core.dom.addClassName;u.add("User.Onclick","mouseover",function(w){t(r.groups[w.data.groupName].getUser(w.data.uid).root,"wbim_hover")});u.add("User.Onclick","mouseout",function(w){v(r.groups[w.data.groupName].getUser(w.data.uid).root,"wbim_hover")})}new h.wbim.ui.SearchBar({container:this.listBox,groupContainer:this.groupParentNode}).render(this.searchNode);this.lazyLoad=new h.wbim.utils.LazyLoader({prop:"imgsrc",container:this.listBox,sltImg:".wbim_userhead img",queue:false,checkLimited:function(){return(r.root.style.display=="none")}});n.add("contactPanel.LazyCheck",function(){r.lazyLoad.check()})}else{this.root.className="wbim_list_expand wbim_list_expand_nof";this.listBox.innerHTML=c(['<div class="wbim_list_nof">','<span class="wbim_icon_tips"></span>#L{还没有可以聊天的好友}<br>','#L{去看看}<a target="_blank" href="http://weibo.com/invite/popularity.php">#L{可能感兴趣的人}</a>',"</div>"].join(""));this.searchNode.style.display="none"}},_bindDataEvent:function(){var q=this;n.add("onlineUser.offline",function(s,r){q._updateGroupData(r)});n.add("onlineUser.online",function(s,r){q._updateGroupData(r)});n.add("updateRecents",function(s,r){q.updateRecents(r)});n.add("updateUsersStatus",function(s,r){q.updateUsersStatus(r)});n.add("rosterUpdate",function(s,r){q.addUser(r)});n.add("rosterRemove",function(s,r){q.removeUser(r)});n.add("OnlineBar.OnClick",function(){!q._openFlg?q.show():q.hide();j.dispatch("contactsPanel.display",q._openFlg)})},_bindDomEvent:function(){var q=i(".wbim_tit_lf",this.root)[0],r=i(".wbim_tit_rt",this.root)[0],t=h.core.evt.addEvent,s=function(v){h.wbim.utils.Core.stopBubble(v)};var u=this;t(this.closeNode,"click",function(){u.hide();j.dispatch("contactsPanel.display")});t(this.closeNode2,"click",function(){u.hide();j.dispatch("contactsPanel.display")});t(i(".wbim_titin",this.root)[0],"click",function(x){var v=x||window.event,w=v.srcElement||v.target;if(w!=r&&w!=q&&!h.core.dom.contains(r,w)&&!h.core.dom.contains(q,w)){u.hide();j.dispatch("contactsPanel.display")}});t(u.feedbackNode,"click",s);t(u.configNode,"click",s)},_bindUISyncEvent:function(){var q=this;j.add("contactsPanel.display",function(s,r){r?q.show():q.hide()})},getGroup:function(s,q,r){if(!this.groups[s]){this.groups[s]=new h.wbim.ui.UserGroup({id:s,type:q,title:r,container:this.listBox})}return this.groups[s]},initGroups:function(q){var s=this,r,u,t=document.createDocumentFragment();m(this.groups,function(v,w){v.clearUsers();v.remove(s.groupParentNode)});r=q[0];u=s.getGroup(d,r.type,k);u.addUsers(r.uidList);u.render(t);m(q[1],function(v,w){if(v&&v.uidList){u=s.getGroup(w,g,(w=="onlineusernogroup"?p:w));u.addUsers(v.uidList);u.render(t)}});this.groupParentNode.appendChild(t);this._updateGroupData()},updateRecents:function(q){this.getGroup(d).sort(q.uid);this._updateGroupData()},updateUsersStatus:function(r){for(var q in r){this.addUser({uid:q})}},addUser:function(t){var v=t.uid.toString(),s=o.getUser(v),w,q,r;if(!s){return}q=s.options;if(q.status=="hide"||q.status=="offline"){return}r=q.group;w=document.createDocumentFragment();for(var u=0;r[u];u++){var y=r[u],x=this.groups[y];if(!x||!x.isRendered()){x=this.getGroup(y,g,(y=="onlineusernogroup"?p:y));x.render(w)}x.addUser(v)}if(w.childNodes.length>0){this.groupParentNode.appendChild(w)}this._updateGroupData()},removeUser:function(r){var q=r.uid.toString();for(var t in this.groups){var s=this.groups[t];if(s.options.type==g){s.removeUser(q)}}},_updateGroupData:function(){var q=this;setTimeout(function(){q.lazyLoad&&q.lazyLoad.check()},10)},show:function(){this._openFlg=true;this.root.style.display="";this.lazyLoad.check();l.fire("writeInitData",["contactsPanel",{openFlg:true}])},hide:function(){this._openFlg=false;this.root.style.display="none";l.fire("writeInitData",["contactsPanel",{openFlg:false}])},isOpen:function(){return this._openFlg}};return b});STK.register("wbim.ui.SearchBar",function(i){var d=i.WBIM.language,m=i.wbim.userData,n=i.wbim.events.ui,f=i.wbim.utils.Core,a=i.core.evt.addEvent,k=i.core.func.bind,l=i.core.arr.foreach,c=i.core.util.templet,j=i.core.arr.indexOf,h=i.core.dom.sizzle,g=d('<li class="noresult">#L{没有找到符合搜索条件的联系人}</li>'),o=d('<li class="noresult wbim_loading" >#L{正在搜索}</li>'),b='<li uid="#{uid}" title="#{nick}" action-type="SearchResult" action-data="uid=#{uid}"><div class="wbim_userhead"><img imgsrc="http://tp#{imgserv}.sinaimg.cn/#{uid}/30/#{avatar}/#{sex}"><span class="wbim_status_#{_cls}"></span></div><div class="wbim_username">#{hilighted}</div></li>';function e(p){this.root=i.C("div");this.root.className="wbim_list_srchin";this.root.innerHTML='<a class="wbim_icon_close_s" style="display:none;" hidefocus="true" href="javascript:void(0)"></a>'+d('<input type="text" value="#L{昵称/备注名}">');this.inputField=h("input",this.root)[0];this.clearNode=h(".wbim_icon_close_s",this.root)[0];this.listNode=i.C("UL");this.listContainer=i.C("DIV");this.listContainer.className="wbim_list_friend";this.listContainer.appendChild(this.listNode);this.container=p.container;this.container.appendChild(this.listContainer);this.groupContainer=p.groupContainer;this.defaultValue=this.inputField.value;this.uidList=[];this.delay=300;this._bindDomEvent();this._bindDataEvent()}e.prototype={render:function(p){p.appendChild(this.root)},_bindDataEvent:function(){var p=this;n.add("searchReturn",function(r,q){p.updateResult2Container(q)})},_bindDomEvent:function(){var q=this,p={"13":function(){q._chosenItem&&n.fire("contactsPanel.userClicked",{uid:q._chosenItem})},"38":function(){this._chooseItemTo(true)},"40":function(){this._chooseItemTo(false)}};f.bindEvents(this.inputField,k(this,this._searchLater),["keyup","paste","cut","focus"]);a(this.inputField,"focus",k(this,this._focus));a(this.inputField,"blur",k(this,this._blur));a(this.inputField,"keyup",function(t){var s=p[t.keyCode];if(s){s.apply(q)}});var r=i.core.evt.delegatedEvent(this.listNode);r.add("SearchResult","click",function(s){var t=s.data.uid;q._chooseItem(t);n.fire("contactsPanel.userClicked",{uid:t})});if(i.core.util.browser.IE6){r.add("SearchResult","mouseover",function(s){i.E("webim_search_"+s.data.uid).className="wbim_hover"});r.add("SearchResult","mouseout",function(s){i.E("webim_search_"+s.data.uid).className=""})}a(this.clearNode,"click",function(){q.clearNode.style.display="none";q.inputField.value=q.defaultValue;q.listNode.innerHTML="";q.hideResult();q.keyword="";q.focusFlag=false})},_getValue:function(){return i.core.str.trim(this.inputField.value)},_searchLater:function(){this._delayTimer&&clearTimeout(this._delayTimer);this._delayTimer=setTimeout(k(this,this.search),this.delay)},search:function(){var p=this._getValue();if(p!=this.keyword){this.clearNode.style.display=(p&&p!=this.defaultValue)?"":"none";this.keyword=p;if(p){n.fire("search",{keyword:p});this.listNode.innerHTML=o}else{this.updateResult2Container()}}this._delayTimer=null},updateResult2Container:function(u){var q=[],t,r,s=this,p=this._getValue();this.uidList=[];if(!u||!p||!m){this.hideResult();return}if(i.core.obj.isEmpty(u)){t=true;l(m.userList,function(w,x){if(w.options.nick.indexOf(p)!=-1){u[x]=w.options;t=false;return false}})}if(t){q.push(g)}else{try{r=new RegExp(p,"gi")}catch(v){r=p}l(u,function(y,x){var z={},w;if(y){z.nick=y.nick;z.uid=y.uid;z.avatar=y.avatar;z.sex=y.sex;z.imgserv=y.uid%4+1;z.hilighted=y.nick.replace(r,function(A){return('<span class="spetxt">'+A+"</span>")});w=y.status;if(y.status!="offline"){if(y.resource=="mobile"){w="mobile"}else{if(y.resource=="desktop"){w="client"}}}z._cls=w;q.push(c(b,z));s.uidList.push(z.uid)}})}this.listNode.innerHTML=q.join("");if(!t){this._chooseItem(this.uidList[0]);n.fire("contactPanel.LazyCheck")}this.showResult()},_chooseItemTo:function(t){var s=this.uidList,p=s.length,r;if(this._chosenItem&&p>0){var q=j(this._chosenItem,s);if(t){q--;if(q<0){q=0}}else{q++;if(q>=p){q=p-1}}r=s[q];this.scrollIntoView(r);this._chooseItem(r)}},scrollIntoView:function(t){var q=this.container,s=this._getElement(t);if(q&&s){var v=q.scrollTop;var u=v+q.clientHeight;var p=s.offsetTop;var r=p+s.clientHeight;if(p<v){q.scrollTop=0}else{if(r>u){q.scrollTop=r-q.clientHeight}}}},_chooseItem:function(p){var q=this._getElement(p);q&&(q.style.backgroundColor="#E9E9E9");if(this._chosenItem){q=this._getElement(this._chosenItem);q&&(q.style.backgroundColor="")}this._chosenItem=p},_focus:function(){if(this.inputField.value==this.defaultValue){this.inputField.value=""}this.focusFlag=true;this.check()},_blur:function(){var p=this;setTimeout(function(){var q=p._getValue();if(!q){p.inputField.value=p.defaultValue}if(q==p.defaultValue){p.focusFlag=false}p.check()},300)},check:function(){var p=this._getValue();if(this.focusFlag&&this.uidList.length>0&&p&&p!=this.defaultValue){this.showResult()}else{this.hideResult()}},_getElement:function(p){return this.listNode.children[j(p,this.uidList)]},showResult:function(){this.listNode.style.display="";this.groupContainer.style.display="none";this.listContainer.style.display=""},hideResult:function(){this._chosenItem=null;this.listNode.style.display="none";this.groupContainer.style.display="";this.listContainer.style.display="none";n.fire("contactPanel.LazyCheck")}};return e});STK.register("wbim.ui.ChatUser",function(g){var s=['<li title=#{nick} uid=#{uid} node-type="user_root"><div class="wbim_userhead">','<img alt=#{nick} src="http://tp#{imgserv}.sinaimg.cn/#{uid}/30/#{avatar}/#{sex}" node-type="wbim_userhead"></img>','<span node-type="wbim_status"></span></div>','<div class="wbim_username" node-type="wbim_username">#{partNick}</div>','<a hidefocus="true" href="javascript:;" class="wbim_icon_close_s" node-type="wbim_icon_close_s"></a>',"</li>"].join(""),k=g.wbim.ui,u=g.core.dom,o=g.core.evt.addEvent,a=g.core.util.templet,l=g.core.evt.stopEvent,m=g.core.str.leftB,n=g.core.obj.parseParam,w=g.core.str.encodeHTML,b="http://weibo.com/#{uid}/profile",v="wbim_active",q="wbim_highlight",f="wbim_status_#{status}",t="wbim_offline",r={desktop:"client",mobile:"mobile"},e=g.wbim.userData,c=g.wbim.events.ui,i=g.wbim.io.SyncData,d=u.hasClassName,p=u.removeClassName,h=u.addClassName;var j=function(B){var x=B.user,y=n({uid:"",nick:"",avatar:"",sex:"",imgserv:"",partNick:""},x.options),z=y.uid,A;y.nick=w(y.nick||"&nbsp;");y.imgserv=z%4+1;y.partNick=m(y.nick,6);A=u.builder(a(s,y));this._root=A.list.user_root[0];this._avatarNode=A.list.wbim_userhead[0];this._nickNode=A.list.wbim_username[0];this._closeBtn=A.list.wbim_icon_close_s[0];this._statusNode=A.list.wbim_status[0];this._profileURL=a(b,{uid:z});this._user=x;this._flashTimes=0;this.changeStatus();this.bindDataEvents();this.bindDomEvents();A=null;y=null;x=null};j.prototype={render:function(x){u.insertElement(x,this._root)},bindDomEvents:function(){var x=this;o(this._root,"click",function(z){var y=z.target||z.srcElement;if(y===x._avatarNode&&x.isActived()){window.open(x._profileURL,"_blank");return}else{if(y===x._closeBtn){c.fire("closeChatUser",x);i.dispatch("chatUser.remove",{uid:x.getUID()})}else{x.active();i.dispatch("chatUser.active",{uid:x.getUID()})}}l()});if(g.core.util.browser.IE6){o(x._root,"mouseover",function(){u.addClassName(x._root,"wbim_hover")});o(x._root,"mouseout",function(){u.removeClassName(x._root,"wbim_hover")})}},bindDataEvents:function(){var x=this;x._user.addEvent("updateUnreadMsgCount",function(y){if(x._user.options.unreadMsgCount>0){c.fire("afterUpdateUnreadMsgCount",x);x.isActived()?x._user.clearUnreadMsgCount():x.flash4NewMsg();x._user.clearUnreadMsg()}});x._user.addEvent("updateStatus",function(){x.changeStatus()})},active:function(){if(this.isActived()){return}c.fire("changeChatUser",this);p(this._root,q);h(this._root,v);this._flashTimes=4;c.fire("activeChatUser",this);this._user.clearUnreadMsgCount()},recover:function(){p(this._root,q);p(this._root,v)},close:function(){this._user.clearUnreadMsgCount();this.recover();this.show();u.removeNode(this._root)},changeStatus:function(){var x=this._user.options.status;if(x!="offline"&&x!="hide"){x=r[this._user.options.resource]||x}if(this._status==x){return}this._statusNode.className=a(f,{status:x});if(x=="offline"){h(this._root,t)}else{p(this._root,t)}this._status=x;c.fire("changeHeaderStatus",this)},flash4NewMsg:function(x){var y=this;if(!x){y._root.className=q;y._flashTimes=0}else{if(y._flashTimes++>3){return}y._root.className=y._flashTimes%2?"":q}setTimeout(function(){y.flash4NewMsg(true)},500)},isActived:function(){return d(this._root,v)},hasNewMsg:function(){return(this._user.options.unreadMsgCount>0)},hideCloseBtn:function(){u.setStyle(this._closeBtn,"display","none")},showCloseBtn:function(){u.setStyle(this._closeBtn,"display","")},getRootNode:function(){return this._root},getUID:function(){return this._user.options.uid},getOpt:function(){return this._user.options},show:function(){u.setStyle(this._root,"display","")},hide:function(){u.setStyle(this._root,"display","none")}};return j});STK.register("wbim.ui.ChatUserGroup",function(g){var q=['<div class="wbim_chat_lf" node-type="wbim_chat_lf">','<a class="wbim_scrolltop_n" node-type="wbim_scrolltop" hidefocus="true" href="javascript:;" onclick="return false;"></a>','<div class="wbim_chat_friend_box">','<ul class="wbim_chat_friend_list" node-type="wbim_chat_friend_list" ></ul>',"</div>",'<a class="wbim_scrollbtm_n" node-type="wbim_scrollbtm" hidefocus="true" href="javascript:;" onclick="return false;"></a>',"</div>"].join(""),d="wbim_scrolltop",c="wbim_scrollbtm",i="wbim_scrolltop_n",f="wbim_scrollbtm_n",o="wbim_scrolltop_a",h="wbim_scrollbtm_a",s=10,n=g.core.evt,r=g.core.dom,k=g.core.arr.indexOf,b=r.hasClassName,a=g.wbim.events.ui,m=g.core.evt.stopEvent,e=g.wbim.userData,j=g.wbim.io.SyncData,p=g.wbim.events.io;var l=function(){var t=r.builder(q);this._root=t.list.wbim_chat_lf[0];this._topBtn=t.list.wbim_scrolltop[0];this._bottomBtn=t.list.wbim_scrollbtm[0];this._listNode=t.list.wbim_chat_friend_list[0];this._userArray=[];this._userList={};this._createdUser={};this._activedUID="";this._visibleStartIndex=0;this._msgCount=0;this.bindDomEvents();this.bindDataEvents();this.bindUISyncEvent();t=null;q=null};l.prototype={render:function(t){r.insertElement(t,this._root)},bindDomEvents:function(){var t=this;n.addEvent(t._topBtn,"click",function(){if(t.isScrollEnable()){if(t._visibleStartIndex>0){t._userList[t._userArray[--t._visibleStartIndex]].show()}}t._check4FlashBtn()});n.addEvent(t._bottomBtn,"click",function(){if(t.isScrollEnable()){if(t._visibleStartIndex+s<t._userArray.length){t._userList[t._userArray[t._visibleStartIndex++]].hide()}}t._check4FlashBtn()})},bindDataEvents:function(){var t=this;a.add("changeChatUser",function(w,x){var v=x.getUID();if(t._activedUID==v){return}if(t._activedUID){var u=t._userList[t._activedUID];u&&!u.hasNewMsg()&&u.recover()}t._activedUID=v});a.add("afterUpdateUnreadMsgCount",function(u,v){if(v.isActived()){t._msgCount-=v.getOpt().unreadMsgCount}else{if(t.isScrollEnable()){t._check4FlashBtn()}}});a.add("activeChatUser",function(x,y){if(t.getUserCount()>1&&t.isHidden()){var z=arguments.callee;setTimeout(function(){z.apply(a,[x,y])},200);return}t._msgCount-=y.getOpt().unreadMsgCount;if(t.isScrollEnable()){var w=y.groupIndex,v=t._visibleStartIndex,u=v+s;if(w<v){for(;w<v;v--){t._userList[t._userArray[--t._visibleStartIndex]].show()}}else{if(w>=u){for(;w>=u;u++){t._userList[t._userArray[t._visibleStartIndex++]].hide()}}}t._scrollObserver()}p.fire("writeInitData",["chatWindow",{userArray:t.getUserArray(),activeUID:y.getUID(),openFlg:true}])});a.add("closeChatUser",function(u,v){t._msgCount-=v.getOpt().unreadMsgCount;t.removeUser(v.getUID());p.fire("writeInitData",["chatWindow",{userArray:t.getUserArray()}])})},bindUISyncEvent:function(){var t=this;j.add("chatUser.active",function(u,v){t._userList[v.uid].active()});j.add("chatUser.remove",function(u,v){t.removeUser(v.uid)})},addUsers:function(v,t){if(t instanceof Array){for(var u=0;t[u];u++){this.addUser(t[u])}}this.addUser(v).active()},addUser:function(u){var t=e.getUser(u);if(this._userList[u]){return this._userList[u]}var v=this.getUser(t);v.render(this._listNode);this._userList[u]=v;this._userArray.push(u);v.groupIndex=this._userArray.length-1;this._scrollObserver();if(this.getUserCount()==2){this._userList[this._userArray[0]].showCloseBtn()}return v},getUser:function(t){var u=t.options.uid;var v=this._createdUser[u];if(!v){v=t.createChatUser();this._createdUser[u]=v;a.fire("chatUserGroup.addUser",v)}return v},addUserByNewMsg:function(t,v){var u=t.options.uid;this._msgCount+=v;if(!this._userList[u]){this.addUser(u);a.fire("addedChatUserByNewMsg")}},removeUser:function(w){var x=this.getUserCount();if(x==1){return}var y=this._userList[w],v=this._userArray;if(y){if(y.isActived()){var u=0;for(;u<x;u++){if(w==v[u]){if((++u)==x){u-=2}break}}this._userList[v[u]].active()}y.close();delete this._userList[w];var t=k(w,v);v.splice(t,1);for(;v[t];t++){this._userList[v[t]].groupIndex--}this._scrollObserver();a.fire("chatUserGroup.removeUser",{uid:w,userArray:this.getUserArray()});if(this.getUserCount()==1){this._userList[this._userArray[0]].hideCloseBtn()}}},removeAll:function(){var u=this._userList;for(var t in u){u[t].close()}if(this.getUserCount()==1){this._userList[this._userArray[0]].showCloseBtn()}this._userList={};this._userArray=[];this._activedUID="";this._visibleStartIndex=0;this._msgCount=0;this._scrollObserver();p.fire("writeInitData",["chatWindow",null])},isChatUser:function(t){return !!this._userList[t]},getUserArray:function(){return this._userArray},getUserCount:function(){return this._userArray.length},_flashTopBtn:function(){!b(this._topBtn,o)&&(this._topBtn.className=o)},_flashBtmBtn:function(){!b(this._bottomBtn,h)&&(this._bottomBtn.className=h)},_check4FlashBtn:function(){var w=this._visibleStartIndex,v=w+s,t=this.getUserCount(),u=true;while(--w>=0){if(this._userList[this._userArray[w]].hasNewMsg()){this._flashTopBtn();u=false;break}}if(u){b(this._topBtn,o)&&(this._topBtn.className=d)}u=true;while(t>v){if(this._userList[this._userArray[v++]].hasNewMsg()){this._flashBtmBtn();u=false;break}}if(u){b(this._bottomBtn,h)&&(this._bottomBtn.className=c)}},isScrollEnable:function(){return(this.getUserCount()>s)},enableScrollBtn:function(){if(this._btnFlg){return}this._topBtn.className=d;this._bottomBtn.className=c;this._btnFlg=true},disableScrollBtn:function(){if(!this._btnFlg){return}this._topBtn.className=i;this._bottomBtn.className=f;this._btnFlg=false},_scrollObserver:function(){this.isScrollEnable()?this.enableScrollBtn():this.disableScrollBtn();var u=this._visibleStartIndex+s,t=this.getUserCount();if(t>9){while(u>t){this._userList[this._userArray[--this._visibleStartIndex]].show();u--}}this._check4FlashBtn()},isHidden:function(){var t=this._root.style;return(t.display=="none"||t.visibility=="hidden")},getActiveUser:function(){return this._userList[this._activedUID]},hide:function(){r.setStyle(this._root,"display","none")},show:function(){r.setStyle(this._root,"display","")},getUnreadCount:function(){return this._msgCount},updateChatUserStatus:function(){var t=this._userArray;for(var x=0;t[x];x++){var w=t[x],y,v,u=this._userList[w];u.changeStatus();if(this._activedUID==w){y={};v=u.getOpt();y[w]={uid:w,status:v.status,resource:v.resource};a.fire("updateUsersStatus",y)}}this._msgCount=0}};return l});STK.register("wbim.ui.ChatWindowHeader",function(g){var c=g.WBIM.language;var e=c(['<div class="wbim_tit" node-type="wbim_tit">','<div class="wbim_titin" node-type="wbim_titin">','<div class="wbim_tit_lf">','<p><span node-type="wbim_status"></span><span class="txt"><a target="_blank" node-type="wbim_tit_lf_name"></a></span><span style="display:none" class="bringin" node-type="wbim_tit_lf_count">#L{正在输入}</span></p></div>','<div class="wbim_tit_rt"><a href="javascript:;" class="wbim_icon_mini" hidefocus="true" title="#L{最小化}" node-type="wbim_icon_mini"></a>','<a href="javascript:;" class="wbim_icon_close" hidefocus="true" title="#L{关闭}" node-type="wbim_icon_close"></a></div>',"</div></div>"].join("")),p=g.core.dom,f=g.core.evt,h=g.wbim.events.ui,n=g.wbim.io.SyncData,l=g.core.evt.stopEvent,a=g.core.dom.setStyle,b=g.core.util.templet,d="http://weibo.com/#{domain}",i="http://api.t.sina.com.cn/users/show.json?source=209678993&user_id=",k=0,o="wbim_status_#{status}",j={desktop:"client",mobile:"mobile"};var m=function(){var q=p.builder(e);this._root=q.list.wbim_tit[0];this._chatName=q.list.wbim_tit_lf_name[0];this._chatCount=q.list.wbim_tit_lf_count[0];this._closeBtn=q.list.wbim_icon_close[0];this._minBtn=q.list.wbim_icon_mini[0];this._minBtn2=q.list.wbim_titin[0];this._statusNode=q.list.wbim_status[0];this.bindDataEvents();this.bindDomEvents();this._currentUID;this.domainCache={};q=null;e=null;this.chatingUser={}};m.prototype={render:function(q){p.insertElement(q,this._root)},bindDataEvents:function(){var q=this;h.add("activeChatUser",function(r,s){q._currentUID=s.getUID();q.updateChatName(s);q.changeStatus(s);q.userInputing(q._currentUID)});h.add("addChartInputing",function(s,t){var r=t+"";q.chatingUser[r]=true;if(r==q._currentUID){q.showChartInputing()}});h.add("stopInputing",function(r,s){delete q.chatingUser[s];if(s==q._currentUID){q.hideChartInputing()}});h.add("changeHeaderStatus",function(r,s){if(s.getUID()==q._currentUID){q.changeStatus(s)}})},bindDomEvents:function(){var q=this;f.addEvent(this._root,"mouseover",function(){q._root.className="wbim_tit wbim_tit_hover"});f.addEvent(this._root,"mouseout",function(){q._root.className="wbim_tit"});f.addEvent(this._root,"click",function(s){var r=s.target||s.srcElement;if(q._closeBtn===r){h.fire("closeChatWindow");n.dispatch("chatWindow.close");l()}else{if(q._minBtn===r||q._minBtn2===r){h.fire("miniChatWindow");n.dispatch("chatWindow.hide");l()}else{if(q._chatName===r){g.wbim.utils.Core.stopBubble(s)}}}})},updateChatName:function(t){p.trimNode(this._chatName);var q=t.getOpt().nick;this._chatName.innerHTML=g.core.str.leftB(g.core.str.encodeHTML(q),12);this._chatName.title=q;var r=t.getUID(),s=this;if(!this.domainCache[r]){g.core.io.jsonp({url:i+r,onComplete:function(u){if(u.domain!==""){s.domainCache[r]=u.domain}else{s.domainCache[r]="u/"+r}s._chatName.setAttribute("href",b(d,{domain:s.domainCache[r]}))}})}else{this._chatName.setAttribute("href",b(d,{domain:this.domainCache[r]}))}},changeStatus:function(s){var r=s.getOpt();var q=r.status;if(q!="offline"&&q!="hide"){q=j[r.resource]||q}else{this.hideChartInputing()}if(this._status==q){return}this._statusNode.className=b(o,{status:q});this._status=q},userInputing:function(q){if(this.chatingUser[q]){this.showChartInputing()}else{this.hideChartInputing()}},showChartInputing:function(){a(this._chatCount,"display","")},hideChartInputing:function(){a(this._chatCount,"display","none")}};return m});STK.register("wbim.ui.MsgEditor",function(e){var v=e.core.util.browser.IE?198:200,m=500,q=e.WBIM.language,d='<div class="wbim_chat_input" node-type="wbim_chat_input" style="margin-top:1px;"><textarea node-type="wbim_chat_input_ta"></textarea></div>',c=q(['<div class="wbim_chat_btm" node-type="wbim_chat_btm">','<div class="wbim_chat_btmin">','<div class="wbim_chat_btm_lf"><a href="http://desktop.weibo.com/?source=webim" target="_blank">#L{微博桌面}</a>#L{传文件，随时分享好东东}</div>','<div class="wbim_chat_btm_rt"><p class="wbim_tips_char">','<span node-type="wbim_tips_char">',v,"</span>",'<span class="spetxt" node-type="spetxt"></span></p>','<div class="wbim_btn_send" node-type="wbim_btn_send"><a hidefocus="true" node-type="wbim_btn_publish" class="wbim_btn_publish" href="javascript:;" title="发送">发送</a>','<div class="wbim_btn_choose"><a node-type="wbim_btn_choose_a" class="wbim_btn_choose_a">选择</a>','<ul node-type="wbim_btn_choose"><li class="curr" node-type="wbim_enter_send_li"><span></span><em><a href="javascript:;" node-type="wbim_enter_send">按Enter键发送</a></em></li>','<li class="line"><span></span><em></em></li>','<li node-type="wbim_ctrlenter_send_li" class=""><span></span><em><a href="javascript:;" node-type="wbim_ctrlenter_send">按Ctrl+Enter键发送</a></em></li>',"</ul></div></div>","</div></div></div>"].join("")),p="wbim_chat_input_dis",j="wbim_btn_publish_none",l=q("##L{分享图片}#"),i=q("##L{分享文件}#"),r=q("#L{不要太贪心哦，发一次就够啦}"),t=50,k=e.wbim.ui,b=e.wbim.events.ui,s=e.wbim.events.io,o=e.core.evt.stopEvent,g=e.core.evt.addEvent,u=e.core.dom,n=e.core.arr.foreach,a=e.core.str.trim,f=e.wbim.io.SyncData;getCaretForIE=function(x,B){var y=document.body||document.documentElement;var C=document.selection.createRange(),z=y.createTextRange(),E=x.value,D=0,F=E.length,w=-1;z.moveToElementText(x);for(D=0;z.compareEndPoints("StartTo"+B,C)<0;D++){z.moveStart("character",1)}for(var A=0;A<=D;A++){if(E.charAt(A)=="\n"){D++}}return D};var h=function(){var x=u.builder(d);var w=u.builder(c);this._editorRoot=x.list.wbim_chat_input[0];this._tipRoot=w.list.wbim_chat_btm[0];this._editorNode=x.list.wbim_chat_input_ta[0];this._sendBtn=w.list.wbim_btn_publish[0];this._sendBtnPanel=w.list.wbim_btn_send[0];this._sendBtnSelect=w.list.wbim_btn_choose_a[0];this._enterSend=w.list.wbim_enter_send[0];this._ctrlenterSend=w.list.wbim_ctrlenter_send[0];this._enterSendLi=w.list.wbim_enter_send_li[0];this._ctrlenterSendLi=w.list.wbim_ctrlenter_send_li[0];this._sendBtnSelectUl=w.list.wbim_btn_choose[0];this._tipNode=w.list.wbim_tips_char[0];this._errorNode=w.list.spetxt[0];if(e.wbim.utils.Core.checkFlashVersion(10)){this._uploadTips=new k.UploadTips();this._uploadTips.render(this._editorRoot);this._uploadTips.hide()}else{k.UploadTips=null}this._attach;this._sentMsg={};this._currentUID;this.bindDomEvents();this.bindDataEvents();this.bindUISyncEvent();this.textLength=0;this.inputingLock=true;this.timeoutID=0;this.enterForSend=true;this.selectPanelFlg=true;x=null;w=null;d=null;c=null};h.prototype={render:function(w){u.insertElement(w,this._editorRoot);u.insertElement(w,this._tipRoot)},bindDataEvents:function(){var w=this;b.add("activeChatUser",function(x,y){w._currentUID=y.getUID()});b.add("phiz.selectPhiz",function(y,x){w.addPhiz(x)});b.add("chatUserGroup.removeUser",function(){setTimeout(function(){w._setFocus()},100)});b.add("activeChatUser",function(){setTimeout(function(){w._setFocus()},100)});b.add("hideUploadTips",function(x){u.removeClassName(w._editorRoot,p);u.removeClassName(w._sendBtn,j);w._attach="";w._checkLength()});b.add("swf.upload.start",function(x,y){u.addClassName(w._editorRoot,p);u.addClassName(w._sendBtn,j);w._attach=""});b.add("swf.upload.complete",function(z,A){u.removeClassName(w._sendBtn,j);var x=A.ext,y,B;if(x.type.indexOf("image")!=-1){B=x.thumbnail;B&&(y=true)}w._attach={fid:x.fid,name:x.name,size:x.size,isImg:y,imgUrl:B};!w.getCharacterLength()&&(w._editorNode.value=y?l:i);w._checkLength();w._saveCursorPos()});b.add("swf.upload.showMsg",function(x,y){u.addClassName(w._editorRoot,p);w._attach=""});b.add("historySendMsg",function(x,y){w._sentMsg[y.uid]=y.msg});b.add("sendButtonChange",function(x,y){w.enterForSend=y;w.checkMarkChange();b.remove("sendButtonChange",arguments.callee)})},bindDomEvents:function(){var x=this,w=x._editorNode;n(["keyup","paste","cut","mousedown","mouseup","keydown","focus"],function(z,y){g(w,z,function(){x._checkLater()})});g(x._sendBtnPanel,"click",function(z){var y=z.srcElement||z.target;switch(y){case x._sendBtn:x.send();w.focus();break;case x._sendBtnSelect:x.activeSetPanel(x.selectPanelFlg);o();break;case x._ctrlenterSend:if(x.enterForSend){x.changeSendMethod()}x.activeSetPanel(false);break;case x._enterSend:if(!x.enterForSend){x.changeSendMethod()}x.activeSetPanel(false)}});g((document.body||document.documentElement),"click",function(y){if(!x.selectPanelFlg){if(!e.core.dom.contains(x._sendBtnSelectUl,(y.srcElement||y.target))){x.activeSetPanel(false)}}});g(w,"keydown",function(z){if(z.keyCode==13){if((x.enterForSend&&!z.ctrlKey)||(!x.enterForSend&&z.ctrlKey)){e.core.evt.stopEvent(z);x.send()}else{if((!x.enterForSend&&!z.ctrlKey)||(x.enterForSend&&z.ctrlKey)){e.core.evt.stopEvent(z);if(document.selection&&document.selection.createRange){w.focus();var y=document.selection.createRange();y.text="\r\n";y.collapse(false);y.select()}else{w.value+="\n"}}}}});if(e.core.util.browser.IE6){g(x._sendBtnSelect,"mouseover",function(){u.setStyle(x._sendBtnSelect,"backgroundPositionY","-30px")});g(x._sendBtnSelect,"mouseout",function(){u.setStyle(x._sendBtnSelect,"backgroundPositionY","0px")})}},bindUISyncEvent:function(){var w=this;f.add("changeSendMethod",function(y,x){w.enterForSend=x;w.checkMarkChange()})},checkMarkChange:function(){if(this.enterForSend){u.removeClassName(this._ctrlenterSendLi,"curr");u.addClassName(this._enterSendLi,"curr")}else{u.removeClassName(this._enterSendLi,"curr");u.addClassName(this._ctrlenterSendLi,"curr")}},changeSendMethod:function(){this.enterForSend=!this.enterForSend;this.checkMarkChange();s.fire("writeInitData",["sendButton",{enter:this.enterForSend}]);f.dispatch("changeSendMethod",this.enterForSend)},activeSetPanel:function(w){if(w){u.setStyle(this._sendBtnSelectUl,"display","block")}else{u.setStyle(this._sendBtnSelectUl,"display","none")}this.selectPanelFlg=!w},_checkLater:function(){var w=this;if(w._checkTimer){clearTimeout(w._checkTimer)}w._checkTimer=setTimeout(function(){w._cutContentForTooMuch();w._checkLength();w._saveCursorPos()},100)},_saveCursorPos:function(){var y=0,w=0,x=this._editorNode;if(x){if(typeof(x.selectionStart)=="number"){y=x.selectionStart;w=x.selectionEnd}else{if(document.selection){y=getCaretForIE(x,"Start");w=getCaretForIE(x,"End")}}}this._cursorPos={start:y,end:w,scrollTop:x.scrollTop}},addPhiz:function(y){var z=this._cursorPos||{start:0,end:0},w=this._editorNode.value,x=y?y.phiz||"":"",w=w.substr(0,z.start)+x+w.substr(z.end);this._cursorPos=this._cursorPos||{start:0,end:0};this._cursorPos.end=z.start+x.length;this._cursorPos.start=this._cursorPos.end;this._editorNode.value=w;this._setFocus();this._checkLength()},_setFocus:function(){if(this.isHidden()){return}var A=this._editorNode;var B=0;var z=0;if(this._cursorPos){B=this._cursorPos.end||0;z=this._cursorPos.scrollTop||0}try{if(typeof(A.selectionStart)=="number"){this._editorNode.focus();A.selectionStart=A.selectionEnd=B}else{if(document.selection){var w=A.createTextRange();var x=A.value;w.collapse(true);B=x.substr(0,B).replace(/[\n]/gi,"").length;w.moveStart("character",B);w.select()}}}catch(y){}A.scrollTop=z},_checkLength:function(){var x=this;var w=this.getCharacterLength();this._attach&&(w+=t);if(w>v){this.overCountHandler(w-v)}else{this.normalCountHandler(v-w)}if(w!=this.textLength){if(x.inputingLock&&w!=0){b.fire("requestInTextarea",{uid:this._currentUID,states:"c"});x.inputingLock=false}if(w!=0){if(x.timeoutID){clearTimeout(x.timeoutID)}x.timeoutID=setTimeout(function(){b.fire("requestInTextarea",{uid:x._currentUID,states:"p"});x.timeoutID=null;x.inputingLock=true},5000)}this.textLength=w}},_cutContentForTooMuch:function(){var w=a(this._editorNode.value);if(w.length>m){this._editorNode.value=w.substr(0,m)}},getCharacterLength:function(){return Math.ceil(a(this._editorNode.value).replace(/[^\x00-\xff]/g,"aa").length/2)},overCountHandler:function(w){this._tipNode.innerHTML="";this._errorNode.innerHTML="-"+w},normalCountHandler:function(w){this._tipNode.innerHTML=w;this._errorNode.innerHTML=""},send:function(){var x,y,w=this._attach,z;if(u.hasClassName(this._sendBtn,j)){return}x=this.getCharacterLength();if((x+(w?t:0))>v||(x==0)){this.flashContentNode();return}y=a(this._editorNode.value);if(!w&&this._sentMsg[this._currentUID]==y){b.fire("showSysTips",{tips:r});return}this._sentMsg[this._currentUID]=w?"":y;b.fire("sendMsg",{msg:y,uid:this._currentUID,ext:w});this._editorNode.value="";this._checkLength();w&&(z=[w.fid]);f.dispatch("msgEditor.sendMsg",{msg:y,uid:this._currentUID,ext:z});this.inputingLock=true;b.fire("requestInTextarea",{uid:this._currentUID,states:"p"})},flashContentNode:function(){var y=this,w=y._editorNode,x=0;if(a(w.value).length==0){w.value=""}(function(){var z=arguments.callee;if(x>3){return}u.setStyle(w,"background",(x++)%2?"":"#ffdddd");setTimeout(function(){z()},150)})()},isHidden:function(){var w=this._editorRoot.style;return(w.display=="none"||w.visibility=="hidden")}};return h});STK.register("wbim.ui.HistoryMsg",function(d){var c=d.WBIM.language,f=c('<a class="wbim_history" node-type="wbim_history" title="#L{聊天记录}" target="_blank" href="#"><span class="wbim_icon_chatdoc"></span>#L{聊天记录}</a>'),a=d.wbim.events.ui,b=d.core.dom;var e=function(){var g=b.builder(f);this._root=g.list.wbim_history[0];this.bindDataEvents();g=null;f=null};e.prototype={render:function(g){b.insertElement(g,this._root);d.core.evt.addEvent(this._root,"click",function(h){d.wbim.utils.Core.stopBubble(h)})},bindDataEvents:function(){var g=this;a.add("activeChatUser",function(h,i){g.changeURL(i.getUID())})},changeURL:function(g){this._root.href="http://weibo.com/message/talklist.php?uid="+g}};return e});STK.register("wbim.ui.Upload",function(d){var a=d.WBIM.language,i=d.core.dom,e=d.wbim.events.ui,g=d.core.evt.addEvent,f="wbim_icon_doc_none",b="wbim_icon_img_none",h=false;function c(k){if(h){return}h=true;var j=(window.$CONFIG&&window.$CONFIG.version)||(new Date()).getTime();setTimeout(function(){h=false},500);return d.core.util.swf.create(k,"http://js.t.sinajs.cn/t4/webim/swf/upload.swf?v=VER".replace("VER",j),{width:"43",height:"18",paras:{allowScriptAccess:"always",wmode:"transparent"},flashvars:{swfid:parseInt(d.wbim.$currentUID),maxSize:1024*1024*50,iExt:"*.jpg; *.gif; *.jpeg; *.png",fExt:"",domain:"http://weibo.com"}})}return{init:function(j){this._swfBox=d.C("div");this._swfBox.style.cssText="position:absolute;z-index:1500;";this._imgRoot=d.C("a");this._fileRoot=d.C("a");this._imgRoot.title=a("#L{上传图片}");this._fileRoot.title=a("#L上传文件}");this._imgRoot.hideFocus=true;this._fileRoot.hideFocus=true;this._imgRoot.className="wbim_icon_img";this._fileRoot.className="wbim_icon_doc";this._key;this._disableFlg;this.bindDataEvent();j.appendChild(this._imgRoot);j.appendChild(this._fileRoot);d.E("wbim_box").appendChild(this._swfBox)},bindDataEvent:function(){var j=this;e.add("activeChatUser",function(k){j._swfObj=j._swfObj||c(j._swfBox);j.recoverSwf();j.showSwf()});e.add("cancelUpload",function(k){j._swfObj.cancelUpload(j._key);j.enable()});e.add("deleteUpload",function(k){j.enable();j._swfObj.resetAll()});e.add("sendMsg",function(k,l){j.enable();j._swfObj.resetAll()});e.add("realCloseChatWindow",function(k){j._disableFlg?j.miniSwf():j.hideSwf()});e.add("chatWindow.hide2Bar",function(k){j._disableFlg?j.miniSwf():j.hideSwf()})},recoverSwf:function(){i.setStyle(this._swfBox,"width","43px");i.setStyle(this._swfBox,"height","18px");i.setStyle(this._swfBox,"bottom","119px");i.setStyle(this._swfBox,"right","435px")},miniSwf:function(){i.setStyle(this._swfBox,"width","1px");i.setStyle(this._swfBox,"height","1px");i.setStyle(this._swfBox,"bottom","2px");i.setStyle(this._swfBox,"right","225px")},hideSwf:function(){i.setStyle(this._swfBox,"display","none")},showSwf:function(){i.setStyle(this._swfBox,"display","")},enable:function(){this._disableFlg=false;this._key="";i.removeClassName(this._fileRoot,f);i.removeClassName(this._imgRoot,b)},disable:function(){this._disableFlg=true;i.addClassName(this._fileRoot,f);i.addClassName(this._imgRoot,b)},start:function(j,l,k){_webim_log("start",j,l,k);this.disable();this._key=k;e.fire("swf.upload.start",{swfid:j,fileName:l,key:k})},cancel:function(j,k){_webim_log("cancel",j,k);this.enable();e.fire("swf.upload.cancel",{swfid:j,key:k})},complete:function(j,k,m,l){_webim_log("complete",j,k,m,l);if(this._key){l.err_msg?this.showMsg(l.err_msg):e.fire("swf.upload.complete",{swfid:j,fileName:m,ext:l,key:k})}else{this._swfObj.resetAll()}},showMsg:function(j){_webim_log("showMsg",j);if(j.indexOf("不可以再添加")!=-1){return}this.enable();e.fire("swf.upload.showMsg",{msg:j})}}});STK.register("wbim.ui.UploadTips",function(d){var c=d.WBIM.language,m=d.core.dom,e=d.wbim.events.ui,h=d.core.evt.stopEvent,l=d.core.dom.sizzle,b=d.core.util.templet,k=c("#L{文件过大，请不要超过50M}"),j=c("#L{上传文件失败，请重新上传}"),i=c("#L{文件名过长，请删减}"),g=c('#L{您的}<a href="http://vdisk.weibo.com/" target="_blank">V#L{盘}</a>#L{空间不足，请删除多余文件}'),f=c("#L{对方微盘已满,请提醒Ta申请扩容}");var a=function(){var o='<div class="wbim_chat_input_tips" node-type="root"><div class="fl" node-type="fl"></div><div class="fr" node-type="fr"></div></div>';var n=m.builder(o);this._root=n.list.root[0];this._rightNode=n.list.fr[0];this._leftNode=n.list.fl[0];this._startHtmlLt=c('<span class="icon_ing"></span>#L{上传文件中}...');this._startHtmlRt=c('<a class="links" href="javascript:;" action-type="cancel">#L{取消}</a>');this._completeHtmlLt='<span class="#{cls}"></span>#{fileName}';this._completeHtmlRt=c('<a class="links" action-type="delete" href="javascript:;">#L{删除}</a>');this._failHtml='<span class="icon_del"></span>';this._closeHtml='<a hidefocus="true" href="javascript:;" action-type="close" class="wbim_icon_close_s"></a>';this._previewNode;this.bindDomEvent();this.bindDataEvent();n=null;o=null};a.prototype={render:function(n){m.insertElement(n,this._root,"afterbegin")},bindDomEvent:function(){var n=this,o=d.core.evt.delegatedEvent(n._root);o.add("cancel","click",function(p){n.hide();e.fire("cancelUpload");h()});o.add("delete","click",function(p){n.hide();e.fire("deleteUpload");h()});o.add("close","click",function(p){n.hide();e.fire("deleteUpload");h()})},bindDataEvent:function(){var n=this;e.add("swf.upload.start",function(o,p){n.start()});e.add("swf.upload.complete",function(o,p){n.complete(p)});e.add("swf.upload.showMsg",function(o,p){n.showMsg(p)});e.add("sendMsg",function(o,p){n.hide()})},start:function(){this._leftNode.innerHTML=this._startHtmlLt;this._rightNode.innerHTML=this._startHtmlRt;this.show()},complete:function(n){this._leftNode.innerHTML=b(this._completeHtmlLt,{cls:n.ext.thumbnail?"wbim_icon_s_photo":"wbim_icon_s_"+d.wbim.utils.Core.getFileImg(n.ext.name),fileName:n.fileName});this._rightNode.innerHTML=this._completeHtmlRt},showMsg:function(o){var n=o.msg;this._rightNode.innerHTML=this._closeHtml;switch(true){case (/繁忙/.test(n)):break;case (/50M/.test(n)):n=k;break;case (/不能太/.test(n)):n=i;break;case (o.err_code==7):n=f;e.fire("uploadFile.rollback",{fid:o.fid});break;case (/不足/.test(n)):n=g;break;default:n=j}this._leftNode.innerHTML=this._failHtml+n;this.show()},show:function(){m.setStyle(this._root,"display","")},hide:function(){m.setStyle(this._root,"display","none");e.fire("hideUploadTips")}};return a});STK.register("wbim.ui.PreviewBox",function(e){var h='<div style="bottom:auto;position:absolute;z-index:1200;right:516px;top:-310px;" node-type="wbim_tips_pos" class="wbim_tips_pos"><div class="wbim_tips_tit"><a hidefocus="true" href="javascript:void(0)" title="下载" node-type="wbim_icon_down" class="wbim_icon_down" target="_blank"></a><a hidefocus="true" href="javascript:void(0)" title="关闭" node-type="wbim_icon_close_s" class="wbim_icon_close_s"></a></div><div class="wbim_tips_pic"><img alt=""><i></i></div></div>',g=e.wbim.ui,d=e.core.dom,b=e.core.evt.addEvent,a=e.wbim.events.ui,f="http://weibo.com/aj/message/attach/download?fid=";var c=function(){var i=d.builder(h);this._root=i.list.wbim_tips_pos[0];this.closeBT=i.list.wbim_icon_close_s[0];this.downBT=i.list.wbim_icon_down[0];this.img=e.sizzle("img",this._root)[0];this._lastImgUrl;this._openFlg;this.bindDomEvents();this.bindDataEvents()};c.prototype={render:function(i){d.insertElement(i,this._root)},bindDomEvents:function(){var i=this;b(this.img,"load",function(j){i.show()});b((document.body||document.documentElement),"click",function(k){k=k||window.event;var j=k.target||k.srcElement;if(i._openFlg){if(j===i.closeBT||!e.core.dom.contains(i._root,j)||j===i.downBT){i.hide()}}})},bindDataEvents:function(){var i=this;a.add("previewBox.changeUrl",function(j,k){var l=k.src;if(i._lastImgUrl&&i._lastImgUrl==l){i.show()}else{i.img.src=i._lastImgUrl=l;i.downBT.href=f+k.fid}});a.add("beforeHideChatWindow",function(j){i.hide()});a.add("activeChatUser",function(j,k){i.hide()})},show:function(){this._openFlg=true;d.setStyle(this._root,"display","block")},hide:function(){this._openFlg=false;d.setStyle(this._root,"display","none")}};return c});STK.register("wbim.ui.MsgToolBar",function(c){var e='<div class="wbim_chat_toolbar" node-type="wbim_chat_toolbar"><div class="wbim_chat_toolbarin" node-type="wbim_chat_toolbarin"></div></div>',d=c.wbim.ui,b=c.core.dom;var a=function(){var f=b.builder(e);this._root=f.list.wbim_chat_toolbar[0];this._container=f.list.wbim_chat_toolbarin[0];this._phiz=new d.Phiz();this._phiz.render(this._container);if(c.wbim.utils.Core.checkFlashVersion(10)){this._upload=d.Upload;this._upload.init(this._container)}else{d.Upload=null}this._historyMsg=new d.HistoryMsg();this._historyMsg.render(this._container);f=null;e=null};a.prototype={render:function(f){b.insertElement(f,this._root)}};return a});STK.register("wbim.ui.Phiz",function(f){var d=f.WBIM.language(['<div class="wbim_face" node-type="wbim_face">','<a class="wbim_icon_face" title="#L{普通表情}" node-type="wbim_icon_face" hidefocus="true" href="javascript:;"></a>','<div class="wbim_face_box" style="display:none;" node-type="wbim_face_box">','<div class="wbim_face_tit">','<div style="top:221px;left:8px;" class="wbim_face_arr"></div>','<div class="wbim_face_tit_lf">#L{普通表情}</div>','<a class="wbim_icon_close" href="javascript:;" node-type="wbim_icon_close"></a></div>','<div class="wbim_face_con">','<ul class="wbim_face_list" node-type="wbim_face_list"></ul>','<div class="tsina_loading cter">','<span class="tsina_ico_ldg"></span>',"</div></div></div></div>"].join("")),c=f.wbim.ui,g=f.wbim.events.ui,h=f.core.evt.addEvent,l=f.core.evt.delegatedEvent,j=f.core.evt.stopEvent,a=f.core.util.templet,o=f.core.dom,k=f.core.arr.foreach,n="http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal",m="wbim_phiz",e='<li><a title="#{phrase}" action-type="wbim_face_a" href="javascript:;"><img imgsrc="#{imgsrc}"/></a></li>',b=function(){var q=window.localStorage,p;if(q){p=q.getItem(m);if(p){p=f.core.json.strToJson(p);if(p.updateVersion=="1.0"&&p.items){g.fire("receiveEmotions",p);return}}}f.core.io.jsonp({url:"http://nas.im.api.weibo.com/im/emotions/emotions.jsonp?v=v1.0",onComplete:function(r){g.fire("receiveEmotions",r);if(q){r.updateVersion="1.0";q.setItem(m,f.core.json.jsonToStr(r))}}})};var i=function(){var p=o.builder(d);this._root=p.list.wbim_face[0];this._btnToggleNode=p.list.wbim_icon_face[0];this._btnCloseNode=p.list.wbim_icon_close[0];this._phizBoxNode=p.list.wbim_face_box[0];this._phizListNode=p.list.wbim_face_list[0];this._imgLazyLoder=new f.wbim.utils.LazyLoader({prop:"imgsrc",container:this._phizBoxNode,sltImg:"img",queue:false,delay:50});this._visible=false;this.bindDomEvent();this.bindDataEvent();b();p=null;d=null;b=null};i.prototype={render:function(p){o.insertElement(p,this._root)},bindDataEvent:function(){var p=this;g.add("receiveEmotions",function(q,r){p._renderEmotions(r.items);g.remove("receiveEmotions",arguments.callee)});g.add("beforeHideChatWindow",function(r,q){p._visible&&p.hidePhizBox()})},bindDomEvent:function(){var p=this;h(p._btnToggleNode,"click",function(q){p[!p._visible?"showPhizBox":"hidePhizBox"]();j()});h(p._btnCloseNode,"click",function(q){p.hidePhizBox();j()});l(p._phizListNode).add("wbim_face_a","click",function(q){p.addPhiz2MsgEditor(q.el);p.hidePhizBox();j()});h((document.body||document.documentElement),"click",function(q){if(p._visible){(!f.core.dom.contains(p._phizBoxNode,(q.srcElement||q.target)))&&p.hidePhizBox()}})},_renderEmotions:function(r){var p=[],q=this;if(!q.phraseHash){q.phraseHash={}}k(r,function(t,s){if(q.phraseHash[t.phrase]){return}q.phraseHash[t.phrase]=true;if(t.category){return}t.imgsrc=n+t.url;p.push(a(e,t))});q._phizListNode.innerHTML=p.join("");n=null;this._renderEmotions=null},addPhiz2MsgEditor:function(p){p&&g.fire("phiz.selectPhiz",{phiz:p.getAttribute("title")})},showPhizBox:function(){o.setStyle(this._phizBoxNode,"display","block");this._imgLazyLoder.check();this._visible=true},hidePhizBox:function(){o.setStyle(this._phizBoxNode,"display","none");this._visible=false}};return i});STK.register("wbim.ui.ConfirmWindow",function(e){var b=e.WBIM.language,d=b(['<div style="left:130px;z-index:100;top:150px;position:absolute;" node-type="wbim_confirm_box"><div class="wbim_confirm_box">','<div class="wbim_confirm_con">','<div class="wbim_confirm_info">','<p class="wbim_confirm_p"><span class="wbim_icon_ask"></span><span class="txt">#L{提示：关闭会话窗口后，其中的未读私信将不再重复提醒。}</span></p>','<p class="wbim_confirm_btn"><a href="javascript:;" class="wbim_btn_c" node-type="wbim_btn_c"><em>#L{确认}</em></a><a href="javascript:;" class="wbim_btn_n" node-type="wbim_btn_n"><em>#L{取消}</em></a></p>','</div></div></div><div style="position:absolute; width:420px; height:365px; top:-126px; left:-130px;" class="wbim_box_pop" node-type="wbim_box_pop"></div></div>'].join("")),c=e.wbim.ui,f=e.wbim.events.ui,g=e.core.evt.addEvent,h=e.core.evt.stopEvent,i=e.wbim.io.SyncData,j=e.core.dom;var a=function(){var k=j.builder(d);this._root=k.list.wbim_confirm_box[0];this._okBtn=k.list.wbim_btn_c[0];this._cancelBtn=k.list.wbim_btn_n[0];this.bindDomEvents();this.bindUISyncEvent();k=null;d=null};a.prototype={render:function(k){j.insertElement(k,this._root)},bindDomEvents:function(){var k=this;g(k._okBtn,"click",function(){k.hide();f.fire("closeChatWindow",true);i.dispatch("confirmWin.hide");i.dispatch("chatWindow.close",true);h()});g(k._cancelBtn,"click",function(){k.hide();i.dispatch("confirmWin.hide");h()})},bindUISyncEvent:function(){var k=this;i.add("confirmWin.hide",function(){k.hide()})},show:function(){j.setStyle(this._root,"display","block")},hide:function(){j.setStyle(this._root,"display","none")},isOpen:function(){var k=this._root.style;return !(k.display=="none"||k.visibility=="hidden")}};return a});STK.register("wbim.ui.MsgIndicator",function(e){var d=e.WBIM.language,b=d("[#L{你有新私信}] "),a=e.wbim.events.ui;var c=function(){this._orgTitle=document.title;this.bindDataEvent()};c.prototype={bindDataEvent:function(){var f=this;a.add("receivedMsg",function(g,h){f.promptUnreadMsg()});a.add("noNewMsg",function(g,h){f.recover()})},promptUnreadMsg:function(){var f=this;document.title=b+this._orgTitle;this._recoverLock&&clearTimeout(this._recoverLock);this._recoverLock=setTimeout(function(){f._recoverLock=false},200)},recover:function(){if(this._recoverLock){var f=this;this._recoverAct&&clearTimeout(this._recoverAct);this._recoverAct=setTimeout(function(){this._recoverAct=false;f.recover()},5000)}else{document.title=this._orgTitle}}};return c});STK.register("wbim.ui.ChatContent",function(y){var J=y.wbim.events.ui,s=y.core.evt.delegatedEvent,w=y.core.evt.stopEvent,B=y.core.evt.addEvent,f=y.core.arr.foreach,v=y.core.dom,e=y.wbim.userData,o=y.core.util.templet,k=y.wbim.utils.date,F=y.core.dom.sizzle,b=y.core.io.jsonp,C=/\\?\[([^\[\]]+)\]/g,E=/[\[\]]/gi,n=/[\r\n]/gi,t=y.WBIM.language,I='<dd class="#{type}"><div class="wbim_msgpos"><div class="msg_time">#{time}</div><div class="msg_box"><p class="txt">#{content}</p>#{uploadField}</div><div class="msg_arr"></div></div></dd>',h='<p class="line"></p><p class="lr" node-key="#{fid}">#{content}</p>',g='<span class="picsbox">#{icon}</span><span class="infos">#{name}<br>#{size}</span><span class="pos">#{status}&nbsp;#{look}</span>',j=t('<em title="#L{文件}" class="wbim_icon_b_NAME"></em>'),G=t('<img title="#L{图片}" alt="#{name}" src="#{imgUrl}" onerror="this.src=SRC;" /><i></i>'.replace("SRC","'http://img.t.sinajs.cn/t4/appstyle/webim/images/file.gif'")),H='<a target="_blank" href="http://weibo.com/aj/message/attach/download?fid=#{fid}">DOW</a>'.replace("DOW",t("#L{下载}")),r='<a class="wbim_img_preview" action-type="wbim_img_preview" fid=#{fid} href="javascript:void(0)">PREVIEW</a>'.replace("PREVIEW",t("#L{预览}")),z=t("#L{该文件已被删除}"),A="wbim_msgr",x="wbim_msgl",i='<dd class="line"></dd>',a="http://api.weibo.com/2/file/attachment/info.json?source=209678993&fid=FID",d="http://api.weibo.com/im/file/imviewThumb.jsonp?size=191&fid=",c="http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal",p=null,l;J.add("receiveEmotions",function(M,L){if(!p){p={};f(L.items,function(O,N){if(O.category){return}p[O.phrase.replace(E,"")]='<img src="'+c+O.url+'"/>'});J.remove("receiveEmotions",arguments.callee)}});function u(L){L=L.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/ /g,"&nbsp;");return L}function D(L){return(Math.ceil(L/1024)+"").substr(0,5)+"K"}function m(L){L=u(L);if(p){L=L.replace(C,function(N,M){if(N.charAt(0)=="\\"){return N.slice(1)}return(p[M]!=undefined)?p[M]:"["+M+"]"})}L=L.replace(n,'</p><p class="txt">');L=L.replace(new RegExp("(http://t.cn/[A-Za-z0-9]{4,6})","gi"),function(M){return'<a href="link" target="_blank" >link</a>'.replace(/link/g,M)});return L}function K(N,L,M){b({url:a.replace("FID",N),onComplete:function(O){O=(O&&O.data)||{};O.fid=O.fid||N;J.fire("receiveFileInfo",{info:O,uid:L,isSend:M})}})}var q=function(L){this._root=y.C("dl");this._root.setAttribute("uid",L);this._user=e.getUser(L);this._insertMsgCache=[];this._unreadCountCache=0;this._unreadMsgCache=[];this._initHTMLCache=[];this._initFidsCache=[];this._lastRecMsg;this.bindDomEvents();this.bindDataEvents();this.getHistoryMsg();this.hide()};q.prototype={render:function(L){v.insertElement(L,this._root)},bindDataEvents:function(){var L=this;this._user.addEvent("historyMsg",function(){L.receiveHistoryMsg();L._user.removeEvent("historyMsg",arguments.callee)});y.wbim.io.SyncData.add("uploadFile.rollback",function(M,N){L.rollbackFile(N.fid)});J.add("uploadFile.rollback",function(M,N){L.rollbackFile(N.fid)})},bindDomEvents:function(){var L=this;s(this._root).add("wbim_img_preview","click",function(N){var M=N.el,P=M.getAttribute("imgUrl"),O=M.getAttribute("fid");if(!l){l=new y.wbim.ui.PreviewBox();l.render(y.E("wbim_box"))}if(P){J.fire("previewBox.changeUrl",{src:P,fid:O})}else{b({url:d+O,varkey:"callback",onComplete:function(Q){P=Q.data;J.fire("previewBox.changeUrl",{src:P,fid:O});M.setAttribute("imgUrl",P)}})}y.core.evt.stopEvent()})},rollbackFile:function(N){var L=N&&F("p[node-key=FID]".replace("FID",N),this._root)[0];if(L){var M=L.children[L.children.length-1];M.style.color="red";M.innerHTML=t("#L{发送失败}")}},addReceivedMsg:function(P,Q){var O=[],M,L=this._user.options,N=this;f((P||L.unreadMsg.reverse()),function(W,T){var V={},U=W[1],S=W[5];if(!S&&N._lastRecMsg==U){return false}N._lastRecMsg=S?"":U;V.content=m(U);V.time=k.format(W[2]);V.type=x;V.uploadField="";if(S){var R=S.length;if(R>1){S=S.slice(R/2,R)}f(S,function(Y,X){K(Y,L.uid);V.uploadField+=o(h,{fid:Y,content:""})})}O.push(o(I,V))});M=O.join("");Q?this._initHTMLCache.push(M):this._appendMsg(M)},addSendMsg:function(P,R){var Q={},O,M=P.ext,N=this._user.options;Q.content=m(P.msg);Q.time=k.format(P.time||k.getCurrentTime());Q.type=A;Q.uploadField="";if(M){if(M instanceof Array){var L=M.length;if(L>1){M=M.slice(0,L/2);f(M,function(T,S){Q.uploadField+=o(h,{fid:T,content:""})});this._initFidsCache.push(M)}else{K(M[0],N.uid,true);Q.uploadField=o(h,{fid:M[0],content:""})}}else{M.icon=M.isImg?o(G,M):j.replace("NAME",y.wbim.utils.Core.getFileImg(M.name));M.size=D(M.size);M.status="";M.look="";Q.uploadField=o(h,{fid:M.fid,content:o(g,M)})}}O=o(I,Q);R?this._initHTMLCache.push(O):this._appendMsg(O)},insertFileInfo:function(N){var M=F('[node-key="'+N.fid+'"]')[0],L;if(!N.name){L=z}else{N.icon=N.isImg?o(G,N):j.replace("NAME",y.wbim.utils.Core.getFileImg(N.name));N.look=(!N.isSend)&&N.isImg?o(r,N):"";N.size=D(N.size);N.status=N.isSend?"":o(H,N);L=o(g,N)}M.innerHTML=L;this.scrollToBottom()},show:function(){v.setStyle(this._root,"display","block")},hide:function(){v.setStyle(this._root,"display","none")},receiveHistoryMsg:function(){var Q=this,S=e.self.uid,O=Q._user.options,P=O.historyMsg,N=Q._unreadMsgCache,R,L,M;_webim_log("receiveHistoryMsg",O.uid,P);P.sort(function(U,T){return T[2]-U[2]});if(Q._unreadCountCache){if(N.length==1){if(N[0][1]==P[0][1]){L=true;if(N[0][5]&&P[0][5]){L=(N[0][5][0]==P[0][5][0])}L&&P.splice(0,1)}else{(P.length>3)&&P.pop()}}else{R=P.splice(0,Q._unreadCountCache)}}f(P.reverse(),function(W){var T=W[0]+"",U,V;if(T==S){U=(W[5]&&W[5].length>0)?W[5]:"",V=W[1];if(!U&&V==M){return true}M=V;Q.addSendMsg({msg:V,time:W[2],ext:U},true);J.fire("historySendMsg",{msg:U?"":V,uid:O.uid})}else{Q.addReceivedMsg([W],true)}});if(P.length>0){Q._initHTMLCache.push(i)}R&&Q.addReceivedMsg(R.reverse(),true);v.insertHTML(this._root,Q._initHTMLCache.join(""),"afterbegin");f(Q._initFidsCache,function(U,T){f(U,function(W,V){K(W,O.uid,true)})});setTimeout(function(){Q.scrollToBottom()},100);this.receiveHistoryMsg=null},getHistoryMsg:function(){var M=this._user.options,L=M.uid;_webim_log("getHistoryMsg",L,M.unreadMsgCount,M.unreadMsg);if(M.unreadMsgCount>0){this._unreadCountCache=M.unreadMsgCount;this._unreadMsgCache=[].concat(M.unreadMsg)}e.getHistoryMsg({uids:L+"",count:(this._unreadCountCache)+3});this.getHistoryMsg=null},_appendMsg:function(L){L&&v.insertHTML(this._root,L);this.scrollToBottom()},scrollToBottom:function(){var L=this._root.parentNode;setTimeout(function(){L.scrollTop=L.scrollHeight},10)}};return q});STK.register("wbim.ui.ChatContentGroup",function(g){var c='<div class="wbim_chat_tips" node-type="wbim_chat_tips"><span class="wbim_icon_tips"></span><span node-type="wbim_chat_tips_content"></span><a hidefocus="true" href="javascript:;" node-type="wbim_icon_close_s" class="wbim_icon_close_s"></a></div>',e=g.wbim.ui,h=g.core.evt.addEvent,j=g.core.evt.stopEvent,i=g.wbim.events.ui,f=g.wbim.events.io,l=g.wbim.io.SyncData,d=g.wbim.userData,m=g.core.dom,b=g.WBIM.language,a={offline:b("#L{对方当前不在线或隐身，可能无法立即回复。}"),busy:b("#L{对方当前忙碌，可能无法立即回复。}"),away:b("#L{对方当前离开，可能无法立即回复。}"),notSend2User:b("#L{私信发送失败，根据对方设置，你不能与他聊天。}")};var k=function(){var n=m.builder(c);this._root=g.C("div");this._root.className="wbim_chat_up";this._container=g.C("div");this._container.className="wbim_chat_list";this._tipsNode=n.list.wbim_chat_tips[0];this._tipsContentNode=n.list.wbim_chat_tips_content[0];this._tipsCloseBtn=n.list.wbim_icon_close_s[0];m.insertElement(this._root,this._tipsNode);m.insertElement(this._root,this._container);this._contents={};this._activedUID="";this._timeout="";this.bindDomEvents();this.bindDataEvents();this.bindUISyncEvent();this.hideTips();n=null;c=null};k.prototype={render:function(n){m.insertElement(n,this._root)},bindDomEvents:function(){var n=this;h(this._tipsCloseBtn,"click",function(o){n.hideTips();j()})},bindDataEvents:function(){var o=this,n;i.add("chatUserGroup.addUser",function(p,q){o.addChatContent(q)});i.add("activeChatUser",function(q,r){_webim_log("ReceivedMsg activeChatUser",r);var p=r.getUID();n=true;o._contents[p].show();o._dispatchReceivedMsg(p);o._checkUserStatus(p)});i.add("afterUpdateUnreadMsgCount",function(q,r){_webim_log("ReceivedMsg afterUpdateUnreadMsgCount",r);var p=r.getUID();o._dispatchReceivedMsg(p);o._checkUserStatus(p)});i.add("sendMsg",function(p,q){_webim_log("SendedMsg ui",q);o._dispatchSendedMsg(q)});i.add("changeChatUser",function(q,r){var p=r.getUID();if(o._activedUID==p){return}o._activedUID&&o._contents[o._activedUID]&&o._contents[o._activedUID].hide();o._activedUID=p});i.add("beforeHideChatWindow",function(){o._timeout&&clearTimeout(o._timeout);o.hideTips();o._timeout="";n=false});i.add("updateUsersStatus",function(q,p){n&&p&&p[o._activedUID]&&o._checkUserStatus(o._activedUID)});i.add("receiveFileInfo",function(t,q){var p=o._contents[q.uid],s=q.info,r,v,u;if(p){if(s.err_msg||!s.name){u={fid:s.fid}}else{if(s.type.indexOf("image")!=-1){v=s.thumbnail;v&&(r=true)}u={fid:s.fid,name:s.name,size:s.size,isSend:q.isSend,isImg:r,imgUrl:v}}p.insertFileInfo(u)}});i.add("showSysTips",function(q,p){o.execTips(p.tips)});f.add("notSend2User",function(q,p){o.execTips(a.notSend2User)});f.add("userIsForbidden",function(q,p){o.execTips(p.msg)})},bindUISyncEvent:function(){var n=this;l.add("msgEditor.sendMsg",function(o,p){_webim_log("SendedMsg server",p);n._dispatchSendedMsg(p)})},addChatContent:function(p){var n=p.getUID(),o=this._contents[n];if(!o){o=this._contents[n]=new e.ChatContent(n);o.render(this._container)}},showTips:function(n){this._tipsContentNode.innerHTML=n;m.setStyle(this._tipsNode,"display","block")},hideTips:function(){m.setStyle(this._tipsNode,"display","none")},execTips:function(o){_webim_log("execTips ui",o);var n=this;if(!o||/^\s+$/.test(o)){return}this.showTips(o);this._timeout&&clearTimeout(this._timeout);this._timeout=setTimeout(function(){n.hideTips();n._timeout=""},3000)},_dispatchReceivedMsg:function(n){this._contents[n].addReceivedMsg()},_dispatchSendedMsg:function(n){this._contents[n.uid].addSendMsg(n)},_checkUserStatus:function(p){var o=d.getUser(p).options,n=o.status,q;switch(true){case ("offline"==n||n=="hide"):q=o.sex;this.showTips(a.offline);break;case ("busy"==n||"away"==n):q=o.sex;this.showTips(a[n]);break;default:this.hideTips()}}};return k});STK.register("wbim.ui.ChatWindow",function(e){var d=['<div class="wbim_chat_box" style="position:absolute;right:199px;bottom:0px;z-index:1001;" node-type="wbim_chat_box">','<div class="wbim_chat_con" node-type="wbim_chat_con" >',"</div></div>"].join(""),b=e.wbim.userData,h=e.core.arr.foreach,c=e.wbim.ui,f=e.wbim.events.ui,j=e.wbim.io.SyncData,i=e.wbim.events.io,k=e.core.dom,g="wbim_chat_box_s";var a=function(){var m=k.builder(d),l;this._root=m.list.wbim_chat_box[0];this._container=m.list.wbim_chat_con[0];new c.ChatWindowHeader().render(this._container);this._chatUserGroup=new c.ChatUserGroup();this._chatUserGroup.render(this._container);l=e.C("div");l.className="wbim_chat_rt";k.insertElement(this._container,l);this._chatContentGroup=new c.ChatContentGroup();this._chatContentGroup.render(l);this._msgToolBar=new c.MsgToolBar();this._msgToolBar.render(l);this._msgEditor=new c.MsgEditor();this._msgEditor.render(l);this._confirmWin=new c.ConfirmWindow();this._confirmWin.render(this._root);this._confirmWin.hide();this._openFlg;this._initData;this._initUsers;this.bindDataEvents();this.bindUISyncEvent();this.hide();m=null;l=null;d=null};a.prototype={render:function(l){k.insertElement(l,this._root)},bindDataEvents:function(){var l=this;f.add("chatWindow.init",function(o,p){var n=l._initData,m;if(n){l._initUsers=n.userArray;m=n.activeUID;if(n.openFlg){h(p.items,function(r,q){if(m==r[0]){b.getUser(r[0]).notify(r[1]);p.items.splice(q,1);return false}});l.activeChatWindow({uid:m})}else{f.fire("chatWindow.hide2Bar",m)}}h(p.items,function(r,q){b.getUser(r[0]).notify(r[1])});l._initData=null;f.add("groupsDataReady",function(){l._chatUserGroup.updateChatUserStatus()});f.remove("chatWindow.init",arguments.callee)});f.add("contactsPanel.userClicked",function(m,n){l.activeChatWindow(n);j.dispatch("contactsPanel.click",n)});f.add("closeChatWindow",function(n,m){f.fire("beforeCloseChatWindow");if(!m&&l._chatUserGroup.getUserCount()>1&&l._chatUserGroup.getUnreadCount()>0){l._confirmWin.show()}else{l.close()}});f.add("miniChatWindow",function(m){l.hide2Bar()});f.add("addedChatUserByNewMsg",function(n){var m=l._chatUserGroup.getUserCount();(m>1)&&l.removeSmallCls()});f.add("receivedMsg",function(o,p){var n=l._initUsers;if(n){for(var m=0;n[m];m++){l._chatUserGroup.addUser(n[m])}l._initUsers=null}l._chatUserGroup.addUserByNewMsg(p.user,(p.msgCount||0))})},bindUISyncEvent:function(){var l=this;j.add("contactsPanel.click",function(m,n){l.activeChatWindow(n)});j.add("chatWindow.hide",function(m,n){l.hide2Bar()});j.add("chatWindow.close",function(n,m){f.fire("closeChatWindow",m)})},_checkUsers:function(p,o,q){for(var n=0;p[n];n++){var m=p[n],l=b.getUser(m);if(!l){b.getUserByVcard(m,{func:o,obj:this,param:q});break}}return !!l},initByStorage:function(m,l){if(m.activeUID){if(!this._checkUsers((m.userArray||[]),arguments.callee,[m,l])){return}this._initData=m}l();this.initByStorage=null},activeChatWindow:function(o){var m=[o.uid],n=o.activeUsers,l=0;if(this._initUsers){n=n?this._initUsers.concat(n):this._initUsers}n&&(m=m.concat(n));if(!this._checkUsers(m,arguments.callee,[o])){return}if(this._initUsers){this._initUsers=null}this._chatUserGroup.addUsers(m[0],n);l=this._chatUserGroup.getUserCount();if(!this._openFlg){this.show()}if(l>1){this.removeSmallCls()}else{this.addSmallCls()}},addSmallCls:function(){if(!this._chatUserGroup.isHidden()){this._chatUserGroup.hide();k.addClassName(this._root,g)}},removeSmallCls:function(){if(this._chatUserGroup.isHidden()){this._chatUserGroup.show();k.removeClassName(this._root,g)}},show:function(l){this._openFlg=true;k.setStyle(this._root,"display","block")},hide2Bar:function(){var m=this._chatUserGroup,l=m.getActiveUser();l.recover();(m.getUserCount()==1)&&this.addSmallCls();this.hide();f.fire("chatWindow.hide2Bar",l.getUID())},hide:function(){f.fire("beforeHideChatWindow");this._openFlg=false;k.setStyle(this._root,"display","none");i.fire("writeInitData",["chatWindow",{openFlg:false}])},close:function(){this.hide();f.fire("realCloseChatWindow");this._chatUserGroup.removeAll()},isOpen:function(){return this._openFlg}};return a});
